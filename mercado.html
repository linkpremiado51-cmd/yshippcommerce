<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Publicar Serviço - YshippCommerce</title>
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- Mantive o estilo base que você forneceu, resumido para evitar duplicação --- */
    :root{--background:#f9fafb;--surface:#fff;--text-primary:#1f2937;--text-secondary:#6b7280;--primary:#7c3aed;--secondary:#10b981;--border:#e5e7eb;--shadow:0 2px 4px rgba(0,0,0,0.1);--gold:#e67e22;--reais:#10b981}
    [data-theme="dark"]{--background:#1f2937;--surface:#374151;--text-primary:#f3f4f6;--text-secondary:#9ca3af;--border:#4b5563}
    *{box-sizing:border-box}body{font-family:Ubuntu,system-ui,Arial;background:var(--background);color:var(--text-primary);min-height:100vh;margin:0}
    .header{background:var(--surface);border-bottom:1px solid var(--border);padding:1rem;display:flex;justify-content:space-between;align-items:center}
    .container{max-width:1200px;margin:1rem auto;padding:0 1rem}
    .status-bar{display:flex;gap:1rem;justify-content:space-between;background:var(--surface);padding:1rem;border-radius:8px;box-shadow:var(--shadow)}
    .balance-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-top:1rem}
    .balance-card{background:var(--surface);padding:1.25rem;border-radius:8px;box-shadow:var(--shadow)}
    .publish-section,.services-store-section,.services-list{background:var(--surface);padding:1.25rem;border-radius:8px;box-shadow:var(--shadow);margin-top:1rem}
    .service-card{border:1px solid var(--border);padding:1rem;border-radius:8px;margin-bottom:1rem}
    .claim-button{background:var(--secondary);color:white;padding:.5rem;border-radius:6px;border:none;cursor:pointer}
    .publish-button{background:var(--secondary);color:white;padding:.75rem;border-radius:8px;border:none;cursor:pointer;width:100%}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:9999}
    .modal .content{background:var(--surface);padding:1rem;border-radius:8px;max-width:520px;width:95%}
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;color:white;font-size:18px;z-index:9998}
    footer{padding:1rem;text-align:center;color:var(--text-secondary);margin-top:2rem}
  </style>
</head>
<body data-theme="light">
  <div id="loadingOverlay">Carregando... aguarde</div>

  <header class="header">
    <h1 style="font-family:Jura,serif">Publicar Serviço - YshippCommerce</h1>
    <div>
      <button id="theme-toggle" style="background:#3498db;color:#fff;padding:.5rem .75rem;border-radius:6px;border:none;cursor:pointer">Alternar Tema</button>
    </div>
  </header>

  <main class="container" id="app">
    <div class="status-bar" aria-live="polite">
      <div>SALDO EM GOLDS <strong id="golds-balance">0</strong></div>
      <div>SALDO EM REAIS <strong id="reais-balance">R$ 0,00</strong></div>
      <div>GOLDS TOTAIS <strong id="golds-total">0</strong></div>
    </div>

    <section class="publish-section" aria-labelledby="publish-title">
      <h2 id="publish-title">Publicar Novo Serviço</h2>
      <form id="publishForm">
        <div style="display:grid;gap:.5rem;margin-top:.75rem">
          <label>Nome do Serviço <input id="serviceName" required/></label>
          <label>Zona/País
            <select id="zone" required>
              <option value="">Selecione</option>
              <option>Internacional</option><option>Brasil</option><option>Estados Unidos</option><option>Europa</option><option>Ásia</option>
            </select>
          </label>
          <label>Tipo de Serviço
            <select id="serviceType" required>
              <option value="">Selecione</option><option>Redes Sociais</option><option>Games</option><option>Tarefas</option><option>Cripto</option>
            </select>
          </label>
          <label>Subcategoria
            <select id="subcategory" required><option>Selecione um tipo acima</option></select>
          </label>

          <div id="stepsContainer">
            <label>Passos do Serviço</label>
            <div class="step-input">
              <textarea class="step" placeholder="Ex.: Acesse o link" required></textarea>
            </div>
            <button type="button" id="addStep" style="width:160px;padding:.5rem;border-radius:6px;border:none;background:#7c3aed;color:white;cursor:pointer;margin-top:.5rem">+ Adicionar Passo</button>
          </div>

          <div id="proofsContainer" style="margin-top:.5rem">
            <label>Provas Necessárias</label>
            <div class="proof-input">
              <select class="proof-type"><option>Texto</option><option>Captura de Tela</option></select>
              <textarea class="proof-desc" placeholder="Ex.: Screenshot da curtida" required></textarea>
            </div>
            <button type="button" id="addProof" style="width:160px;padding:.5rem;border-radius:6px;border:none;background:#10b981;color:white;cursor:pointer;margin-top:.5rem">+ Adicionar Prova</button>
          </div>

          <label>Freelancers Necessários <input id="freelancers" type="number" min="1" value="1" required/></label>
          <label>Recompensa por Tarefa (Golds) <input id="rewardGolds" type="number" min="1" value="1" required/></label>
          <label>Número de Celular (com DDD) <input id="phone" type="tel" placeholder="+55..." required/></label>

          <div>Custo Total: <strong id="totalCost">0</strong> Golds</div>
          <button class="publish-button" type="submit">Publicar Serviço</button>
        </div>
      </form>
    </section>

    <section class="services-store-section" aria-labelledby="services-title">
      <h2 id="services-title">Serviços Disponíveis</h2>
      <div id="carousel" style="margin-top:.75rem"></div>
    </section>

    <section class="services-list" aria-labelledby="myservices-title">
      <h2 id="myservices-title">Seus Serviços Publicados</h2>
      <div id="userServices" style="margin-top:.75rem"></div>
    </section>
  </main>

  <!-- Modais simples -->
  <div id="successModal" class="modal"><div class="content"><h3>Sucesso</h3><p id="successText"></p><button onclick="closeModal('successModal')">OK</button></div></div>
  <div id="errorModal" class="modal"><div class="content"><h3>Erro</h3><p id="errorText"></p><button onclick="closeModal('errorModal')">OK</button></div></div>

  <footer>© 2025 YshippCommerce</footer>

  <!-- Firebase (modular) -->
  <script type="module">
    // Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, addDoc, collection,
      query, where, orderBy, limit, serverTimestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Config (corrigi storageBucket -> appspot.com)
    const firebaseConfig = {
      apiKey: "AIzaSyDbxygCeFLDbf6Ge6YZHJqq0VvlSSfbc_I",
      authDomain: "yshippcommerce.firebaseapp.com",
      projectId: "yshippcommerce",
      storageBucket: "yshippcommerce.appspot.com",
      messagingSenderId: "680576769517",
      appId: "1:680576769517:web:ace30d8e451ee70511dbe4"
    };

    // Inicializa
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const loadingOverlay = document.getElementById('loadingOverlay');
    const goldsBalanceEl = document.getElementById('golds-balance');
    const reaisBalanceEl = document.getElementById('reais-balance');
    const goldsTotalEl = document.getElementById('golds-total');
    const carouselEl = document.getElementById('carousel');
    const userServicesEl = document.getElementById('userServices');
    const totalCostEl = document.getElementById('totalCost');

    let currentUser = null;
    let walletUnsub = null;
    let servicesUnsub = null;
    let publicUnsub = null;

    // Helpers modais
    function showModal(id, text) {
      document.getElementById(id+'Text').textContent = text;
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const b = document.body;
      const next = b.dataset.theme === 'light' ? 'dark' : 'light';
      b.dataset.theme = next;
      localStorage.setItem('theme', next);
    });
    // apply saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.body.dataset.theme = savedTheme;

    // Subcategory logic
    const subcategoriesMap = {
      'Redes Sociais': ['TikTok','Instagram','Facebook','YouTube','Kwai'],
      'Games': ['Mobile Legends','Free Fire','Roblox','PUBG','Fortnite'],
      'Tarefas': ['Pesquisas','Cliques','Comentários','Compartilhamentos'],
      'Cripto': ['Wallet Connect','Tasks Faucet','NFTs','Airdrops']
    };
    document.getElementById('serviceType').addEventListener('change', () => {
      const v = document.getElementById('serviceType').value;
      const sel = document.getElementById('subcategory');
      sel.innerHTML = '';
      (subcategoriesMap[v]||[]).forEach(s => {
        const opt = document.createElement('option'); opt.value = s; opt.textContent = s; sel.appendChild(opt);
      });
      if(!subcategoriesMap[v]) sel.innerHTML = '<option>Selecione um tipo de serviço primeiro</option>';
    });

    // Add step/proof UI
    document.getElementById('addStep').addEventListener('click', () => {
      const div = document.createElement('div'); div.className = 'step-input';
      div.innerHTML = '<textarea class="step" placeholder="Ex.: Acesse o link" required></textarea>';
      document.getElementById('stepsContainer').insertBefore(div, document.getElementById('addStep'));
    });
    document.getElementById('addProof').addEventListener('click', () => {
      const div = document.createElement('div'); div.className='proof-input';
      div.innerHTML = '<select class="proof-type"><option>Texto</option><option>Captura de Tela</option></select><textarea class="proof-desc" placeholder="Descrição da prova" required></textarea>';
      document.getElementById('proofsContainer').insertBefore(div, document.getElementById('addProof'));
    });

    // Calculate cost
    function calculateCost() {
      const freelancers = Number(document.getElementById('freelancers').value||0);
      const reward = Number(document.getElementById('rewardGolds').value||0);
      const total = freelancers * reward;
      totalCostEl.textContent = total;
    }
    document.getElementById('freelancers').addEventListener('input', calculateCost);
    document.getElementById('rewardGolds').addEventListener('input', calculateCost);
    calculateCost();

    // Ensure wallet exists
    async function ensureWalletExists(uid, name) {
      const ref = doc(db, 'wallets', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { userId: uid, name: name||'Usuário', goldsBalance: 0, reaisBalance: 0, transactions: [], createdAt: serverTimestamp() });
      }
    }

    // Load wallet in real time
    function subscribeWallet(uid) {
      if (walletUnsub) walletUnsub();
      const ref = doc(db, 'wallets', uid);
      walletUnsub = onSnapshot(ref, snap => {
        if (snap.exists()) {
          const d = snap.data();
          goldsBalanceEl.textContent = (d.goldsBalance||0).toLocaleString();
          reaisBalanceEl.textContent = `R$ ${(d.reaisBalance||0).toFixed(2).replace('.',',')}`;
          goldsTotalEl.textContent = (d.goldsTotal||d.goldsBalance||0).toLocaleString();
        } else {
          goldsBalanceEl.textContent = '0';
          reaisBalanceEl.textContent = 'R$ 0,00';
          goldsTotalEl.textContent = '0';
        }
      }, err => console.error('wallet onSnapshot err', err));
    }

    // Load user services
    function subscribeUserServices(uid) {
      if (servicesUnsub) servicesUnsub();
      const q = query(collection(db, 'services'), where('ownerId','==',uid), orderBy('createdAt','desc'));
      servicesUnsub = onSnapshot(q, snap => {
        const list = [];
        snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
        renderUserServices(list);
      }, err=>console.error('user services err',err));
    }

    // Load public services
    function subscribePublicServices(uid) {
      if (publicUnsub) publicUnsub();
      const q = query(collection(db,'services'), where('status','==','ativo'), orderBy('createdAt','desc'), limit(20));
      publicUnsub = onSnapshot(q, snap => {
        const list = []; snap.forEach(d=> { const s = d.data(); s.id = d.id; if (s.ownerId !== uid) list.push(s); });
        renderPublicServices(list);
      }, err=>console.error('public services err',err));
    }

    // Render functions
    function renderPublicServices(services) {
      if (!carouselEl) return;
      if (services.length === 0) { carouselEl.innerHTML = '<p>Nenhum serviço disponível.</p>'; return; }
      carouselEl.innerHTML = '';
      services.forEach(s => {
        const div = document.createElement('div'); div.className='service-card';
        div.innerHTML = `
          <h3>${escapeHtml(s.title||'Sem título')}</h3>
          <p>Zona: ${escapeHtml(s.zone||'-')}</p>
          <p>Recompensa: <strong>${Number(s.rewardGolds||0)} Golds</strong></p>
          <p>Status: ${escapeHtml(s.status||'--')}</p>
          <div style="margin-top:.5rem">
            <button class="claim-button" data-id="${s.id}" data-owner="${s.ownerId}" data-reward="${Number(s.rewardGolds||0)}">Reivindicar</button>
          </div>
        `;
        carouselEl.appendChild(div);
      });
      // attach claim handlers
      carouselEl.querySelectorAll('.claim-button').forEach(btn => btn.addEventListener('click', (ev)=>{
        const id = btn.dataset.id; const owner = btn.dataset.owner; const reward = Number(btn.dataset.reward||0);
        claimService(id, owner, reward);
      }));
    }
    function renderUserServices(services) {
      userServicesEl.innerHTML = '';
      if (!services.length) { userServicesEl.innerHTML = '<p>Nenhum serviço publicado.</p>'; return; }
      services.forEach(s=>{
        const div = document.createElement('div'); div.className='service-card';
        div.innerHTML = `<h3>${escapeHtml(s.title||'Sem título')}</h3>
          <p>Zona: ${escapeHtml(s.zone||'-')}</p>
          <p>Recompensa: <strong>${Number(s.rewardGolds||0)} Golds</strong></p>
          <p>Status: ${escapeHtml(s.status||'--')}</p>
          <div style="margin-top:.5rem">
            <button onclick="editLocal('${s.id}')" style="margin-right:.5rem">Editar</button>
            <button onclick="deleteService('${s.id}')">Excluir</button>
            ${s.status==='aguardando_confirmação' ? `<button onclick="confirmProof('${s.id}','${s.claimedBy||''}')">Confirmar Prova</button>` : ''}
          </div>`;
        userServicesEl.appendChild(div);
      });
    }

    // Utility escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]); }

    // Claim flow (runTransaction)
    async function claimService(serviceId, ownerId, rewardGolds) {
      if (!currentUser) { showModal('errorModal','Faça login para reivindicar'); return; }
      if (currentUser.uid === ownerId) { showModal('errorModal','Você não pode reivindicar seu próprio serviço'); return; }
      try {
        await runTransaction(db, async (tx) => {
          const serviceRef = doc(db,'services',serviceId);
          const serviceSnap = await tx.get(serviceRef);
          if (!serviceSnap.exists()) throw new Error('Serviço não encontrado');
          const s = serviceSnap.data();
          if (s.status !== 'ativo') throw new Error('Serviço não disponível');
          const ownerRef = doc(db,'wallets',ownerId);
          const claimantRef = doc(db,'wallets',currentUser.uid);
          const ownerSnap = await tx.get(ownerRef);
          const claimantSnap = await tx.get(claimantRef);
          const ownerBal = ownerSnap.exists()? (ownerSnap.data().goldsBalance||0) : 0;
          const claimantBal = claimantSnap.exists()? (claimantSnap.data().goldsBalance||0) : 0;
          if (ownerBal < rewardGolds) throw new Error('Saldo do dono insuficiente');
          // update service
          tx.update(serviceRef, { status:'concluído', claimedBy: currentUser.uid, claimedAt: serverTimestamp() });
          // debit owner
          tx.update(ownerRef, { goldsBalance: ownerBal - rewardGolds, transactions: (ownerSnap.data().transactions||[]).concat([{type:'service_payout',amount:-rewardGolds,description:`Pagamento serviço ${serviceId}`,date:serverTimestamp()}]) });
          // credit claimant
          tx.update(claimantRef, { goldsBalance: claimantBal + rewardGolds, transactions: (claimantSnap.data().transactions||[]).concat([{type:'service_claim',amount:rewardGolds,description:`Reivindicou serviço ${serviceId}`,date:serverTimestamp()}])});
        });
        showModal('successModal','Serviço reivindicado e recompensa aplicada.');
      } catch (err) {
        console.error('claim err', err);
        showModal('errorModal', err.message || 'Erro ao reivindicar');
      }
    }

    // Publish service
    document.getElementById('publishForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if (!currentUser) { showModal('errorModal','Faça login para publicar um serviço'); return; }
      const title = document.getElementById('serviceName').value.trim();
      const zone = document.getElementById('zone').value;
      const serviceType = document.getElementById('serviceType').value;
      const subcategory = document.getElementById('subcategory').value;
      const freelancers = Number(document.getElementById('freelancers').value||1);
      const rewardGolds = Number(document.getElementById('rewardGolds').value||1);
      const phone = document.getElementById('phone').value.trim();
      const steps = Array.from(document.querySelectorAll('.step')).map(i=>i.value.trim()).filter(Boolean);
      const proofs = Array.from(document.querySelectorAll('.proof-input')).map(pi=>({
        type: pi.querySelector('.proof-type')?.value || 'Texto',
        description: pi.querySelector('.proof-desc')?.value || ''
      })).filter(p=>p.description);
      const price = freelancers * rewardGolds;
      const publicationFee = 20;

      if (!title || !zone || !serviceType || !subcategory || steps.length===0 || proofs.length===0 || !phone || rewardGolds<=0) {
        showModal('errorModal','Preencha todos os campos, inclua pelo menos um passo e uma prova.');
        return;
      }

      try {
        // ensure wallet exists
        await ensureWalletExists(currentUser.uid, currentUser.displayName||'Usuário');

        // transaction: debit wallet + create service
        await runTransaction(db, async (tx) => {
          const walletRef = doc(db,'wallets',currentUser.uid);
          const walletSnap = await tx.get(walletRef);
          const currentBal = walletSnap.exists()? (walletSnap.data().goldsBalance||0) : 0;
          if (currentBal < price + publicationFee) throw new Error('Saldo insuficiente para publicar (taxa + custo).');

          // create service doc
          const newServiceRef = (await addDoc(collection(db,'services'), {
            ownerId: currentUser.uid,
            ownerName: currentUser.displayName || 'Usuário',
            title, zone, serviceType, subcategory, steps, proofs, freelancers, phone,
            price, rewardGolds, status:'ativo', createdAt: serverTimestamp()
          })).withConverter? null : null; // dummy to use addDoc, tx cannot set on addDoc; we'll emulate: addDoc is outside transaction in this pattern

          // NOTE: because Firestore transactions don't support addDoc directly (unless you use server SDK),
          // simpler approach: debit wallet in transaction, then add service document after.
          tx.update(walletRef, { goldsBalance: currentBal - (price + publicationFee), transactions: (walletSnap.data().transactions||[]).concat([{type:'service_publication',amount:-(price+publicationFee),description:`Publicou serviço ${title}`,date:serverTimestamp()}]) });
        });

        // after successful transaction debit, create service doc (outside tx)
        const sRef = await addDoc(collection(db,'services'), {
          ownerId: currentUser.uid,
          ownerName: currentUser.displayName || 'Usuário',
          title, zone, serviceType, subcategory, steps, proofs, freelancers, phone,
          price, rewardGolds, status:'ativo', createdAt: serverTimestamp()
        });

        showModal('successModal','Serviço publicado com sucesso!');
        document.getElementById('publishForm').reset();
        calculateCost();
      } catch (err) {
        console.error('publish err', err);
        showModal('errorModal', err.message || 'Erro ao publicar serviço');
      }
    });

    // Delete service (owner only)
    async function deleteService(serviceId) {
      try {
        const sRef = doc(db,'services',serviceId);
        const sSnap = await getDoc(sRef);
        if (!sSnap.exists()) { showModal('errorModal','Serviço não encontrado'); return; }
        const s = sSnap.data();
        if (!currentUser || s.ownerId !== currentUser.uid) { showModal('errorModal','Sem permissão'); return; }
        // simple deletion
        await sRef.delete();
        showModal('successModal','Serviço excluído');
      } catch (err) {
        console.error('delete err', err);
        showModal('errorModal','Erro ao excluir serviço');
      }
    }

    // small helpers for confirm proof (skeleton)
    async function confirmProof(serviceId, claimantId) {
      try {
        if (!currentUser) throw new Error('Faça login');
        const sRef = doc(db,'services',serviceId);
        const sSnap = await getDoc(sRef);
        if (!sSnap.exists()) throw new Error('Serviço não encontrado');
        const s = sSnap.data();
        if (s.ownerId !== currentUser.uid) throw new Error('Você não é o dono');
        if (s.status !== 'aguardando_confirmação') throw new Error('Nada para confirmar');

        // mark finalized and credit claimant (simple update)
        await runTransaction(db, async tx=>{
          const claimantRef = doc(db,'wallets',claimantId);
          const claimantSnap = await tx.get(claimantRef);
          const claimantBal = claimantSnap.exists()? claimantSnap.data().goldsBalance||0 : 0;
          tx.update(doc(db,'services',serviceId), { status:'finalizado', finalizedAt: serverTimestamp() });
          tx.update(claimantRef, { goldsBalance: claimantBal + (s.rewardGolds||0), transactions: (claimantSnap.data()?.transactions||[]).concat([{type:'finalizacao_servico',amount:s.rewardGolds||0,description:`Serviço finalizado ${serviceId}`,date:serverTimestamp()}])});
        });
        showModal('successModal','Prova confirmada e usuário creditado.');
      } catch(err) { console.error(err); showModal('errorModal', err.message || 'Erro ao confirmar prova'); }
    }

    // escape for inline edit hook
    window.editLocal = (id) => { showModal('successModal','Editar não implementado na UI compacta'); };

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        // ensure wallet and subscribe
        try { await ensureWalletExists(user.uid, user.displayName||'Usuário'); } catch(e){ console.error(e) }
        subscribeWallet(user.uid);
        subscribeUserServices(user.uid);
        subscribePublicServices(user.uid);
        loadingOverlay.style.display = 'none';
      } else {
        // if you want anonymous fallback uncomment next lines:
        // try { await signInAnonymously(auth); return; } catch(e){ console.error('anon err',e); }
        loadingOverlay.style.display = 'none';
        // redirect to cadastro/login page
        window.location.href = 'cadastro.html';
      }
    });

    // small utility for serverTimestamp in client code
    function serverTimestamp() { return serverTimestamp; /* placeholder, used only inside transactions where serverTimestamp import is valid */ }

    // hide modals when clicked outside
    document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', (e)=>{ if (e.target===m) m.style.display='none'; }));
  </script>
</body>
</html>
