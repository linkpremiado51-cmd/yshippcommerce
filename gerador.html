<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Gerencie sua carteira e ganhe Golds visualizando propagandas no YshippCommerce">
  <title>Tarefas - YshippCommerce</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300..700&family=PT+Sans&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: #f9fafb;
      --surface: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --primary: #7c3aed;
      --primary-hover: #6d28d9;
      --secondary: #10b981;
      --secondary-hover: #059669;
      --border: #e5e7eb;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --accent: #ff6b6b;
      --nsfw-bg: #e74c3c;
      --nsfw-hover: #c0392b;
      --gold: #e67e22;
      --reais: #10b981;
      --progress-bg: #ecf0f1;
      --tutorial-bg: #3498db;
      --tutorial-hover: #2980b9;
    }

    [data-theme="dark"] {
      --background: #1f2937;
      --surface: #374151;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border: #4b5563;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      --accent: #ff8787;
      --nsfw-bg: #c0392b;
      --nsfw-hover: #a5281a;
      --gold: #e6a24b;
      --reais: #059669;
      --progress-bg: #4b5563;
      --tutorial-bg: #1e90ff;
      --tutorial-hover: #1c86ee;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
    }

    body {
      font-family: 'Ubuntu', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding-top: 72px;
      overflow-x: hidden;
    }

    .header-menu {
      font-family: 'PT Sans', sans-serif;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      z-index: 1001;
      box-shadow: var(--shadow);
    }

    .top-bar__section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .top-bar__icon {
      position: relative;
      color: var(--text-primary);
      background: none;
      border: none;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .top-bar__icon i {
      position: relative;
      font-size: 1.25rem;
    }

    .top-bar__icon:hover {
      transform: scale(1.1);
    }

    .menu {
      position: fixed;
      top: 72px;
      left: 0;
      width: 280px;
      height: calc(100vh - 72px);
      background: var(--surface);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .menu.open {
      transform: translateX(0);
    }

    .menu__list {
      list-style: none;
      padding: 16px 0;
    }

    .menu__item {
      margin: 8px 16px;
    }

    .menu__link {
      color: var(--text-primary);
      text-decoration: none;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-radius: 12px;
      transition: none;
      position: relative;
      overflow: hidden;
      background: transparent;
    }

    .menu__link i {
      margin-right: 12px;
      font-size: 1.25rem;
      color: var(--text-secondary);
    }

    .submenu {
      margin-top: 4px;
      padding-left: 48px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .submenu.open {
      max-height: 300px;
    }

    .submenu__link {
      color: var(--text-secondary);
      padding: 8px 16px;
      font-size: 0.9375rem;
      display: block;
      text-decoration: none;
      transition: none;
    }

    .premium-button {
      background: var(--secondary);
      color: var(--text-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      width: calc(100% - 32px);
      margin: 16px;
      font-weight: 500;
      transition: none;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background: var(--surface);
      color: var(--text-primary);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 2000;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 768px) {
      .menu {
        width: min(80vw, 280px);
      }

      .header {
        padding: 0 12px;
      }

      .top-bar__icon {
        padding: 8px;
      }

      .top-bar__icon i {
        font-size: 1.2rem;
      }

      .menu__link {
        padding: 10px 12px;
        font-size: 0.9rem;
      }

      .menu__link i {
        font-size: 1.1rem;
      }

      .submenu__link {
        font-size: 0.85rem;
        padding: 6px 12px;
      }

      .premium-button {
        padding: 10px 20px;
        font-size: 0.9rem;
      }

      .notification {
        right: 10px;
        bottom: 10px;
        padding: 10px 20px;
      }
    }

    .status-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      padding: 1rem;
      background: var(--surface);
      box-shadow: var(--shadow);
      gap: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 600;
      width: 100%;
      max-width: 1200px;
      border-radius: 0.375rem;
      margin: 1rem 0;
    }
    .status-bar div {
      padding: 0.75rem;
      background: var(--background);
      border-radius: 0.375rem;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .status-bar div:hover {
      background: var(--secondary);
      color: white;
      transform: translateY(-3px);
    }
    .status-bar span.golds-balance,
    .status-bar span#golds-total {
      color: var(--gold);
      font-size: 1.125rem;
      font-weight: bold;
    }
    .status-bar span.reais-balance {
      color: var(--reais);
      font-size: 1.125rem;
      font-weight: bold;
    }
    .ads-section {
      width: 100%;
      max-width: 1200px;
      padding: 1.5rem 1rem;
      background: var(--surface);
      border-radius: 0.375rem;
      box-shadow: var(--shadow);
      margin: 1.5rem 0;
      animation: fadeIn 0.5s ease forwards;
    }
    .ads-section h2 {
      font-family: 'Jura', sans-serif;
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .carousel-container {
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      display: flex;
      gap: 1rem;
      padding: 0 1rem 1rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
      justify-content: center;
    }
    .carousel-container::-webkit-scrollbar {
      display: none;
    }
    .carousel-container .ad-card {
      flex: 0 0 90%;
      max-width: 200px;
      scroll-snap-align: center;
      position: relative;
      min-height: 275px;
    }
    .ad-card {
      background: var(--background);
      border-radius: 0.375rem;
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid var(--border);
      position: relative;
    }
    .ad-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .ad-card h3 {
      font-family: 'Jura', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .ad-card p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .ad-card .golds-reward {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gold);
      margin: 0.5rem 0;
    }
    .ad-card .steps-list {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .ad-card .steps-list ul {
      list-style-type: disc;
      padding-left: 1.25rem;
    }
    .ad-card .view-button {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      padding: 0.75rem;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .ad-card .view-button:hover {
      background: var(--secondary-hover);
      transform: scale(1.05);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 0rem;
      text-align: center;
      animation: slideIn 0.5s ease forwards;
      max-width: 90%;
      width: 500px;
      box-shadow: var(--shadow);
    }
    .modal-content h2 {
      font-family: 'Jura', sans-serif;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }
    .modal-content p {
      color: var(--text-secondary);
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }
    .modal-content input {
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 0rem;
      font-size: 0.875rem;
      width: 100%;
      max-width: 200px;
    }
    .modal-content button {
      padding: 0.5rem 1rem;
      background: var(--secondary);
      border: none;
      color: white;
      border-radius: 0rem;
      cursor: pointer;
      font-weight: 600;
      margin: 0.25rem;
      font-size: 0.875rem;
    }
    .modal-content button.cancel {
      background: var(--accent);
    }
    .modal-content button.cancel:hover {
      background: var(--nsfw-hover);
      transform: scale(1.05);
    }
    .modal-content button:hover {
      background: var(--secondary-hover);
      transform: scale(1.05);
    }
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      color: var(--text-primary);
      padding: 1rem;
      box-shadow: var(--shadow);
      border-top: 1px solid var(--border);
      z-index: 1000;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      text-align: center;
    }
    .cookie-banner.active {
      display: flex;
    }
    [data-theme="dark"] .cookie-banner {
      background: var(--surface);
      border-top: 1px solid var(--border);
    }
    .cookie-banner .content {
      font-size: 0.875rem;
    }
    .cookie-banner .content a {
      color: var(--primary);
      text-decoration: underline;
    }
    .cookie-banner .content a:hover {
      color: var(--primary-hover);
    }
    .cookie-banner .buttons {
      display: flex;
      gap: 0.5rem;
    }
    .cookie-banner button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 0.875rem;
    }
    .cookie-banner button.accept {
      background: var(--secondary);
      color: white;
    }
    .cookie-banner button.accept:hover {
      background: var(--secondary-hover);
    }
    .cookie-banner button.decline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .cookie-banner button.decline:hover {
      background: var(--accent);
      color: white;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @media (max-width: 600px) {
      .header {
        padding: 0.75rem;
        flex-direction: row;
        gap: 0.5rem;
      }
      .header h1 {
        font-size: 1.25rem;
      }
      .status-bar {
        font-size: 0.75rem;
        padding: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      .status-bar div {
        padding: 0.5rem;
      }
      .ads-section {
        padding: 1rem 0.5rem;
      }
      .ads-section h2 {
        font-size: 1.25rem;
      }
      .carousel-container {
        padding: 0 0.5rem 1rem;
      }
      .carousel-container .ad-card {
        flex: 0 0 95%;
        max-width: 350px;
      }
      .modal-content {
        padding: 1rem;
        width: 90%;
      }
      .cookie-banner .buttons {
        flex-direction: column;
        width: 100%;
      }
      .cookie-banner button {
        width: 100%;
      }
    }
    @media (min-width: 601px) and (max-width: 1024px) {
      .header h1 {
        font-size: 1.5rem;
      }
      .ads-section {
        padding: 1rem;
      }
      .ads-section h2 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);color:white;font-size:18px;z-index:9999;">
    Carregando dados do gerador...
  </div>
  <div id="userStatus" style="background:black;color:lime;padding:6px;position:fixed;top:0;left:0;z-index:9999;font-size:12px">
    Usuário ativo: Carregando...
  </div>
  <div class="header-menu">
    <nav aria-label="Navegação principal" class="header" role="navigation">
      <div class="top-bar__section">
        <h1>Centro de Comando - YshippCommerce</h1>
      </div>
      <div class="top-bar__section">
        <button aria-label="Alternar menu" class="top-bar__icon" id="menu-icon">
          <i class="fas fa-bars"></i>
        </button>
        <button aria-label="Alternar tema claro/escuro" class="top-bar__icon" id="theme-toggle" title="Alternar tema">
          <i class="fas fa-adjust"></i>
        </button>
      </div>
    </nav>
    <nav aria-label="Menu principal" class="menu" id="main-menu">
      <ul class="menu__list">
        <li class="menu__item">
          <button class="menu__link" onclick="navigateTo('home')">
            <i class="fas fa-home"></i>
            <span class="bold-text">Página Principal</span>
          </button>
        </li>
        <li class="menu__item">
          <button class="menu__link" onclick="navigateTo('market')">
            <i class="fas fa-briefcase"></i>
            <span class="bold-text">Mercado de Serviços</span>
          </button>
        </li>
        <li class="menu__item">
          <button class="menu__link" onclick="navigateTo('store')">
            <i class="fas fa-shopping-cart"></i>
            <span class="bold-text">Loja</span>
          </button>
        </li>
        <li class="menu__item">
          <button class="menu__link" onclick="navigateTo('generator')">
            <i class="fas fa-ticket-alt"></i>
            <span class="bold-text">Gerador de Bilhetes</span>
          </button>
        </li>
        <li class="menu__item">
          <button class="menu__link" onclick="navigateTo('wallet')">
            <i class="fas fa-wallet"></i>
            <span class="bold-text">Carteira</span>
          </button>
        </li>
        <li class="menu__item">
          <button class="menu__link" id="logout-button">
            <i class="fas fa-sign-out-alt"></i>
            <span class="bold-text">Sair</span>
          </button>
        </li>
      </ul>
    </nav>
  </div>
  <div class="notification" id="notification"></div>
  <div id="overlay" class="overlay"></div>

  <main class="flex-grow w-full">
    <div class="status-bar" role="region" aria-label="Resumo de Saldo">
      <div>SALDO EM GOLDS <span class="golds-balance" id="golds-balance"></span></div>
      <div>SALDO EM REAIS <span class="reais-balance" id="reais-balance">R$ 0</span></div>
      <div>GOLDS TOTAIS <span id="golds-total"></span></div>
    </div>
    <section class="ads-section">
      <h2>Gerador de Golds Via Links Curtos</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Acesse links curtos e ganhe 150 Golds por visualização.</p>
      <div class="carousel-container" id="links-carousel"></div>
    </section>
    <section class="ads-section">
      <h2>Gerador de Golds Via Cripto</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Realize tarefas de criptomoedas e ganhe Golds inserindo o código fornecido.</p>
      <div class="carousel-container" id="crypto-carousel"></div>
    </section>
    <section class="ads-section">
      <h2>Gerador de Golds Via Tasks</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Realize tarefas e ganhe Golds inserindo o código fornecido.</p>
      <div class="carousel-container" id="tasks-carousel"></div>
    </section>
    <div id="welcomeModal" class="modal" role="dialog" aria-labelledby="welcomeMessage">
      <div class="modal-content">
        <h2 id="welcomeMessage">Aviso</h2>
        <p></p>
        <button class="secondary-button" onclick="closeModal('welcomeModal')">OK</button>
      </div>
    </div>
    <div id="cryptoModal" class="modal" role="dialog" aria-labelledby="cryptoMessage">
      <div class="modal-content">
        <h2 id="cryptoMessage">Insira o Código</h2>
        <p>Insira o código fornecido para reivindicar seus Golds.</p>
        <input type="text" id="cryptoCode" placeholder="Digite o código">
        <button onclick="submitCryptoCode()">Confirmar</button>
        <button class="cancel" onclick="closeModal('cryptoModal')">Cancelar</button>
      </div>
    </div>
    <div id="cookieBanner" class="cookie-banner">
      <div class="content">
        <p>Concordo que meu endereço IP seja coletado e enviado ao administrador para identificar atividades.</p>
      </div>
      <div class="buttons">
        <button class="accept" onclick="acceptIPConsent()">Aceitar</button>
        <button class="decline" onclick="declineIPConsent()">Recusar</button>
      </div>
    </div>
  </main>
  <footer class="footer py-4 mt-auto w-full">
    <div class="container text-center">
      <p class="text-sm">© 2025 YshippCommerce. Todos os direitos reservados. Desenvolvido por xAI.</p>
      <div class="flex justify-center space-x-4 mt-2">
        <a href="#" class="text-primary text-sm hover:underline">WhatsApp</a>
        <a href="#" class="text-primary text-sm hover:underline">Facebook</a>
      </div>
    </div>
  </footer>
  <footer id="userInfoFooter" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #0d1117;
    color: #00ffaa;
    text-align: center;
    font-size: 13px;
    padding: 6px;
    border-top: 1px solid #00ffaa;
    z-index: 9999;
    font-family: 'Ubuntu', sans-serif;">
    Usuário: <span id="footerUserName">Carregando...</span> | ID: <span id="footerUserId">---</span>
  </footer>
  <script>
    // Menu and navigation functionality
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggles = {
        'menu-icon': 'main-menu'
      };

      Object.entries(menuToggles).forEach(([toggleId, menuId]) => {
        const toggle = document.getElementById(toggleId);
        const menu = document.getElementById(menuId);
        if (!toggle || !menu) {
          console.error(`Elemento ${toggleId} ou ${menuId} não encontrado`);
          return;
        }
        toggle.addEventListener('click', e => {
          e.stopPropagation();
          menu.classList.toggle('open');
          toggle.classList.toggle('active');
        });
      });

      document.addEventListener('click', e => {
        if (!e.target.closest('.menu') && !e.target.closest('.top-bar__icon')) {
          Object.values(menuToggles).forEach(menuId => {
            const menu = document.getElementById(menuId);
            if (menu) menu.classList.remove('open');
          });
          document.querySelectorAll('.top-bar__icon').forEach(icon => {
            if (icon) icon.classList.remove('active');
          });
        }
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          Object.values(menuToggles).forEach(menuId => {
            const menu = document.getElementById(menuId);
            if (menu) menu.classList.remove('open');
          });
          document.querySelectorAll('.top-bar__icon').forEach(icon => {
            if (icon) icon.classList.remove('active');
          });
        }
      });

      // Theme toggle functionality
      const themeToggle = document.getElementById('theme-toggle');
      const body = document.body;
      themeToggle.addEventListener('click', () => {
        const currentTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
      });

      // Apply saved theme on page load
      window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
      });

      // Logout functionality
      document.getElementById("logout-button").addEventListener("click", () => {
        auth.signOut().then(() => window.location.href = "cadastro.html");
      });
    });

    // 🔧 Configuração Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDbxygCeFLDbf6Ge6YZHJqq0VvlSSfbc_I",
      authDomain: "yshippcommerce.firebaseapp.com",
      projectId: "yshippcommerce",
      storageBucket: "yshippcommerce.firebasestorage.app",
      messagingSenderId: "680576769517",
      appId: "1:680576769517:web:ace30d8e451ee70511dbe4"
    };

    // 🔧 Inicializar Firebase globalmente
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    window._YSHIPP_db = db;
    window._YSHIPP_auth = auth;

    // Debug: Verificar se Firebase está carregado
    console.log("[DEBUG] Firebase conectado. Versão:", firebase.SDK_VERSION || 'compat');
    console.assert(typeof firebase !== 'undefined', '[DEBUG] Firebase ainda está indefinido — verifique as tags <script>.');

    // Constants
    const ADMIN_PHONE = "5535984072446";

    // Modal control with enhanced notification styling
    function showModal(modalId, message, autoClose = true, type = 'sucesso') {
      const modal = document.getElementById(modalId);
      const modalText = modal.querySelector('p');
      modalText.textContent = message;
      modalText.style.color = type === 'erro' ? 'var(--accent)' : 'var(--reais)';
      modal.style.display = 'flex';
      if (autoClose && !message.includes('redirecionado')) {
        setTimeout(() => {
          modal.style.display = 'none';
        }, 3000);
      }
      console.log(`[DEBUG] Modal exibido: ${modalId}, Mensagem: ${message}, Tipo: ${type}`);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      console.log("[DEBUG] Modal fechado:", modalId);
    }

    // IP consent handling
    function acceptIPConsent() {
      localStorage.setItem('ipConsent', 'true');
      document.getElementById('cookieBanner').classList.remove('active');
      console.log("[DEBUG] Consentimento de IP aceito.");
    }

    function declineIPConsent() {
      localStorage.setItem('ipConsent', 'false');
      document.getElementById('cookieBanner').classList.remove('active');
      showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.', false, 'erro');
      console.log("[DEBUG] Consentimento de IP recusado.");
    }

    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        console.log("[DEBUG] IP do usuário obtido:", data.ip);
        return data.ip || 'IP não disponível';
      } catch (error) {
        console.error('[DEBUG] Erro ao obter IP:', error);
        return 'IP não disponível';
      }
    }

    // Update UI with wallet data
    function updateInterface(walletData) {
      const goldsBalance = walletData.goldsBalance || 0;
      const reaisBalance = walletData.reaisBalance || 0;
      document.getElementById('golds-balance').textContent = goldsBalance.toLocaleString();
      document.getElementById('reais-balance').textContent = `R$ ${reaisBalance.toFixed(2).replace('.', ',')}`;
      document.getElementById('golds-total').textContent = goldsBalance.toLocaleString();
      console.log("[DEBUG] Interface atualizada com dados da carteira:", walletData);
    }

    // Update user status across UI elements
    function updateUserStatus(uid) {
      const userStatus = document.getElementById("userStatus");
      const footerUserId = document.getElementById("footerUserId");
      if (userStatus) userStatus.textContent = `Usuário ativo: ${uid}`;
      if (footerUserId) footerUserId.textContent = uid;
      console.log("[DEBUG] Status do usuário atualizado para UID:", uid);
    }

    async function updateFooterUserName(uid) {
      try {
        const userDoc = await db.collection("wallets").doc(uid).get();
        if (userDoc.exists && userDoc.data().name) {
          document.getElementById("footerUserName").textContent = userDoc.data().name;
        } else {
          document.getElementById("footerUserName").textContent = "Usuário Anônimo";
        }
      } catch (error) {
        console.error("⚠️ Erro ao buscar nome do usuário:", error);
        document.getElementById("footerUserName").textContent = "Usuário Desconhecido";
      }
    }

    // Load ads into carousels
    function loadLinksCarousel(links) {
      const carousel = document.getElementById('links-carousel');
      carousel.innerHTML = '';
      links.slice(0, 5).forEach(ad => {
        const golds = ad.golds ?? ad.reward ?? 0;
        const card = document.createElement('div');
        card.classList.add('ad-card');
        card.innerHTML = `
          <h3>${ad.title}</h3>
          <div class="steps-list">
            <strong>Passos:</strong>
            <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
          </div>
          <div class="golds-reward"><strong>Recompensa:</strong> ${golds} Golds</div>
          <button class="view-button" onclick="window.open('${ad.url || '#'}', '_blank'); viewAd('${ad.id}', ${golds})">${ad.buttonText || 'Visualizar Propaganda'}</button>
        `;
        carousel.appendChild(card);
      });
      if (links.length === 0) {
        carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum link disponível.</p>';
      }
      console.log("[DEBUG] Carrossel de links carregado:", links.length, "itens");
    }

    function loadCryptoCarousel(cryptoAds) {
      const carousel = document.getElementById('crypto-carousel');
      carousel.innerHTML = '';
      cryptoAds.slice(0, 1).forEach(ad => {
        const golds = ad.golds ?? ad.reward ?? 0;
        const card = document.createElement('div');
        card.classList.add('ad-card');
        card.innerHTML = `
          <h3>${ad.title}</h3>
          <div class="steps-list">
            <strong>Passos:</strong>
            <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
          </div>
          <div class="golds-reward"><strong>Recompensa:</strong> ${golds} Golds</div>
          <button class="view-button" onclick="showCryptoModal('${ad.id}', ${golds}, '${ad.code}')">${ad.buttonText || 'Insira o Código'}</button>
        `;
        carousel.appendChild(card);
      });
      if (cryptoAds.length === 0) {
        carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma tarefa de cripto disponível.</p>';
      }
      console.log("[DEBUG] Carrossel de cripto carregado:", cryptoAds.length, "itens");
    }

    async function loadTasksCarousel(tasks) {
      const carousel = document.getElementById('tasks-carousel');
      carousel.innerHTML = '';
      tasks.slice(0, 6).forEach(ad => {
        const reward = ad.golds ?? ad.reward ?? 0;
        const freelancersNeeded = ad.freelancersNeeded ?? ad.slots ?? null;
        const acceptedCount = (ad.acceptedBy && ad.acceptedBy.length) || 0;
        const vagasText = freelancersNeeded ? ` | Vagas: ${Math.max(0, freelancersNeeded - acceptedCount)}` : '';
        const card = document.createElement('div');
        card.classList.add('ad-card');
        card.innerHTML = `
          <h3>${ad.title}</h3>
          <div class="steps-list">
            <strong>Passos:</strong>
            <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
          </div>
          <div class="golds-reward"><strong>Recompensa:</strong> ${reward} Golds${vagasText}</div>
          <button class="view-button" onclick="acceptTask('${ad.id}', ${reward})">${ad.buttonText || 'Aceitar Tarefa'}</button>
        `;
        carousel.appendChild(card);
      });
      if (tasks.length === 0) {
        carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma task disponível.</p>';
      }
      console.log("[DEBUG] Carrossel de tarefas carregado:", tasks.length, "itens");
    }

    // Handle ad viewing
    function viewAd(adId, golds) {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.', true, 'erro');
        return;
      }
      sincronizarGeradorFirebase(userId, adId, golds, `Visualização de link curto ID: ${adId}`, 'receive');
      showModal('welcomeModal', `Você ganhou ${golds} Golds por visualizar o link!`, true, 'sucesso');
    }

    // Handle crypto modal
    function showCryptoModal(adId, golds, code) {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.', true, 'erro');
        return;
      }
      if (localStorage.getItem('ipConsent') !== 'true') {
        showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.', false, 'erro');
        return;
      }
      window.currentAdId = adId;
      window.currentGolds = golds;
      window.expectedCode = code;
      document.getElementById('cryptoModal').style.display = 'flex';
      console.log("[DEBUG] Modal de cripto aberto para adId:", adId);
    }

    async function submitCryptoCode() {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.', true, 'erro');
        return;
      }
      if (localStorage.getItem('ipConsent') !== 'true') {
        showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.', false, 'erro');
        return;
      }
      const inputCode = document.getElementById('cryptoCode').value.trim();
      if (inputCode === window.expectedCode) {
        try {
          const ip = await getUserIP();
          const doc = await db.collection('wallets').doc(userId).get();
          if (doc.exists) {
            const walletData = doc.data();
            const message = `Reivindicação de Cripto:\nUsuário: ${walletData.name}\nUserID: ${userId}\nCódigo: ${inputCode}\nGolds: ${window.currentGolds}\nIP: ${ip}`;
            sincronizarGeradorFirebase(userId, window.currentAdId, window.currentGolds, `Reivindicação de cripto ID: ${window.currentAdId}`, 'receive');
            showModal('welcomeModal', `Você será redirecionado para o WhatsApp em 8 segundos para enviar as informações ao atendimento.`, false, 'sucesso');
            setTimeout(() => {
              const whatsappUrl = `https://wa.me/${ADMIN_PHONE}?text=${encodeURIComponent(message)}`;
              window.open(whatsappUrl, '_blank');
              closeModal('cryptoModal');
            }, 8000);
          } else {
            showModal('welcomeModal', 'Carteira não encontrada. Tente novamente.', true, 'erro');
          }
        } catch (error) {
          console.error('[DEBUG] Erro ao verificar carteira:', error);
          showModal('welcomeModal', 'Erro ao verificar carteira. Tente novamente.', true, 'erro');
        }
      } else {
        showModal('welcomeModal', 'Código incorreto. Tente novamente.', true, 'erro');
      }
    }

    async function acceptTask(adId, reward) {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.', true, 'erro');
        return;
      }
      if (localStorage.getItem('ipConsent') !== 'true') {
        showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.', false, 'erro');
        return;
      }
      const adRef = db.collection('offers').doc(adId);
      const walletRef = db.collection('wallets').doc(userId);
      try {
        await db.runTransaction(async (t) => {
          const adDoc = await t.get(adRef);
          if (!adDoc.exists) throw new Error('Tarefa não encontrada.');
          const ad = adDoc.data();
          const required = ad.freelancersNeeded ?? ad.slots ?? null;
          const acceptedBy = Array.isArray(ad.acceptedBy) ? ad.acceptedBy.slice() : [];
          if (acceptedBy.includes(userId)) {
            throw new Error('Você já aceitou esta tarefa.');
          }
          if (required !== null && acceptedBy.length >= required) {
            throw new Error('Vagas para esta tarefa esgotadas.');
          }
          acceptedBy.push(userId);
          const newAdUpdate = { acceptedBy: acceptedBy };
          if (required !== null && acceptedBy.length >= required) {
            newAdUpdate.active = false;
          }
          t.update(adRef, newAdUpdate);
          const walletDoc = await t.get(walletRef);
          const newTransaction = {
            type: 'receive',
            amount: reward,
            currency: 'golds',
            date: new Date().toISOString(),
            description: `Aceitação da tarefa ${adId}`
          };
          if (!walletDoc.exists) {
            t.set(walletRef, {
              userId: userId,
              name: auth.currentUser?.displayName || 'Usuário',
              goldsBalance: reward,
              reaisBalance: 0,
              transactions: [newTransaction]
            });
          } else {
            const w = walletDoc.data();
            const current = Number(w.goldsBalance || 0);
            const txs = Array.isArray(w.transactions) ? w.transactions.slice() : [];
            txs.unshift(newTransaction);
            t.update(walletRef, {
              goldsBalance: current + reward,
              transactions: txs
            });
          }
        });
        const walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
        walletData.goldsBalance = (walletData.goldsBalance || 0) + reward;
        walletData.transactions = walletData.transactions || [];
        walletData.transactions.unshift({
          type: 'receive',
          amount: reward,
          currency: 'golds',
          date: new Date().toISOString(),
          description: `Aceitação da tarefa ${adId}`
        });
        localStorage.setItem('walletData', JSON.stringify(walletData));
        updateInterface({ goldsBalance: walletData.goldsBalance, reaisBalance: walletData.reaisBalance || 0, transactions: walletData.transactions });
        showModal('welcomeModal', `Você ganhou ${reward} Golds por aceitar a tarefa!`, true, 'sucesso');
      } catch (err) {
        console.error('[DEBUG] Erro ao aceitar tarefa:', err);
        showModal('welcomeModal', err.message || 'Erro ao aceitar tarefa. Tente novamente.', true, 'erro');
      }
    }

    // Synchronize generator data with Firestore
    async function sincronizarGeradorFirebase(userId, adId, golds, description, type) {
      try {
        const doc = await db.collection('wallets').doc(userId).get();
        if (doc.exists) {
          const walletData = doc.data();
          const newTransaction = {
            type: type,
            amount: golds,
            currency: 'golds',
            date: new Date().toLocaleString('pt-BR'),
            description: description
          };
          await db.collection('wallets').doc(userId).update({
            goldsBalance: walletData.goldsBalance + golds,
            transactions: [newTransaction, ...(walletData.transactions || [])]
          });
          localStorage.setItem('walletData', JSON.stringify({
            userId: walletData.userId,
            name: walletData.name,
            goldsBalance: walletData.goldsBalance + golds,
            reaisBalance: walletData.reaisBalance,
            transactions: [newTransaction, ...(walletData.transactions || [])]
          }));
          console.log("[DEBUG] Ganhos sincronizados para adId:", adId, "Golds:", golds);
        } else {
          showModal('welcomeModal', 'Carteira não encontrada. Tente novamente.', true, 'erro');
        }
      } catch (error) {
        console.error('[DEBUG] Erro ao sincronizar ganhos:', error);
        showModal('welcomeModal', 'Erro ao registrar ganhos. Tente novamente.', true, 'erro');
      }
    }

    // Load generator data from Firestore
    async function carregarGeradorFirebase(userId) {
      console.log("[DEBUG] carregarGeradorFirebase chamado para UID:", userId, "db?", !!db, "auth?", !!auth);

      // Initialize UI with default wallet values to prevent delay
      const defaultWallet = {
        userId: userId,
        name: auth.currentUser?.displayName || 'Usuário',
        goldsBalance: 0,
        reaisBalance: 0,
        transactions: []
      };
      updateInterface(defaultWallet);

      try {
        // Load wallet data
        const walletDoc = await db.collection('wallets').doc(userId).get();
        if (walletDoc.exists) {
          const walletData = walletDoc.data();
          console.log("[DEBUG] Carteira carregada:", walletData);
          updateInterface(walletData);
          localStorage.setItem('walletData', JSON.stringify({
            userId: walletData.userId,
            name: walletData.name,
            goldsBalance: walletData.goldsBalance,
            reaisBalance: walletData.reaisBalance,
            transactions: walletData.transactions
          }));
        } else {
          await db.collection('wallets').doc(userId).set(defaultWallet);
          console.log('[DEBUG] Default wallet created for user:', userId);
          updateInterface(defaultWallet);
          localStorage.setItem('walletData', JSON.stringify(defaultWallet));
        }

        // Load offers
        const querySnapshot = await db.collection('offers').where('active', '==', true).get();
        console.log('[DEBUG] Snapshot offers recebido:', querySnapshot.size, 'itens');
        const links = [];
        const cryptoAds = [];
        const tasks = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const offer = { id: doc.id, ...data };
          if (data.type === 'Link curto') {
            links.push(offer);
          } else if (data.type === 'Cripto') {
            cryptoAds.push(offer);
          } else if (['Task', 'tasks', 'tasksList'].includes(data.type)) {
            tasks.push(offer);
          }
        });
        loadLinksCarousel(links);
        loadCryptoCarousel(cryptoAds);
        loadTasksCarousel(tasks);

        // Hide loading overlay
        document.getElementById("loadingOverlay").style.display = "none";
      } catch (error) {
        console.error('[DEBUG] Erro ao carregar dados:', error);
        showModal('welcomeModal', 'Erro ao carregar dados. Tente novamente.', true, 'erro');
        document.getElementById("loadingOverlay").style.display = "none";
      }
    }

    // Firebase Authentication with persistent UID
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem("ipConsent") === "true") {
        const banner = document.getElementById("cookieBanner");
        if (banner) banner.classList.add('active');
      }
    });

    window.addEventListener('load', () => {
      console.log("[DEBUG] Aguardando autenticação...");

      // Check for cached UID
      const storedUID = localStorage.getItem("userUID");
      if (storedUID && !navigator.onLine) {
        console.log("[DEBUG] UID local detectado (offline):", storedUID);
        updateUserStatus(storedUID);
        updateFooterUserName(storedUID);
        carregarGeradorFirebase(storedUID);
        showModal('welcomeModal', 'Você está offline. Usando dados em cache.', false, 'erro');
        document.getElementById("loadingOverlay").style.display = "none";
        return;
      }

      // Firebase authentication
      auth.onAuthStateChanged((user) => {
        if (user) {
          const uid = user.uid;
          console.log("[DEBUG] Usuário logado:", uid);
          localStorage.setItem("userUID", uid);
          updateUserStatus(uid);
          updateFooterUserName(uid);
          carregarGeradorFirebase(uid);
          if (localStorage.getItem('ipConsent') !== 'true') {
            document.getElementById('cookieBanner').classList.add('active');
            console.log("[DEBUG] Banner de consentimento exibido.");
          }
        } else {
          console.log("[DEBUG] Nenhum usuário logado. Tentando login anônimo...");
          auth.signInAnonymously()
            .then((cred) => {
              console.log("✅ Login anônimo realizado com sucesso.");
              const uid = cred.user.uid;
              localStorage.setItem("userUID", uid);
              updateUserStatus(uid);
              updateFooterUserName(uid);
              carregarGeradorFirebase(uid);
              if (localStorage.getItem('ipConsent') !== 'true') {
                document.getElementById('cookieBanner').classList.add('active');
                console.log("[DEBUG] Banner de consentimento exibido após login anônimo.");
              }
              document.getElementById("loadingOverlay").style.display = "none";
            })
            .catch((error) => {
              console.error("❌ Erro no login anônimo:", error.code, error.message);
              showModal('welcomeModal', "Erro ao autenticar: " + error.message, true, 'erro');
              document.getElementById("loadingOverlay").style.display = "none";
            });
        }
      });
    });

    // Connectivity detection
    window.addEventListener("offline", () => {
      console.log("[DEBUG] Conexão perdida.");
      showModal('welcomeModal', 'Sem conexão com a internet. Tentando reconectar...', false, 'erro');
    });

    window.addEventListener("online", () => {
      console.log("[DEBUG] Conexão restabelecida.");
      showModal('welcomeModal', 'Reconectado. Recarregando dados...', true, 'sucesso');
      location.reload();
    });

    function navigateTo(page) {
      switch(page) {
        case 'wallet':
          window.location.href = "carteira.html";
          break;
        case 'generator':
          window.location.href = "gerador.html";
          break;
        case 'market':
          window.location.href = "mercado.html";
          break;
        case 'store':
          window.location.href = "loja.html";
          break;
        case 'service':
          window.location.href = "servicos.html";
          break;
        case 'raffles':
          window.location.href = "sorteios.html";
          break;
        case 'home':
        default:
          window.location.href = "index.html";
          break;
      }
    }

    // Expose functions for inline event handlers
    window.closeModal = closeModal;
    window.acceptIPConsent = acceptIPConsent;
    window.declineIPConsent = declineIPConsent;
    window.viewAd = viewAd;
    window.showCryptoModal = showCryptoModal;
    window.submitCryptoCode = submitCryptoCode;
    window.acceptTask = acceptTask;
    window.navigateTo = navigateTo;
  </script>
  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return '';
        }
      }
      return gk_fileData[filename] || '';
    }
  </script>
</body>
</html>
