<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Gerencie sua carteira e ganhe Golds visualizando propagandas no YshippCommerce">
  <title>Carteira - YshippCommerce</title>
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: #f9fafb;
      --surface: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --primary: #7c3aed;
      --primary-hover: #6d28d9;
      --secondary: #10b981;
      --secondary-hover: #059669;
      --border: #e5e7eb;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --accent: #ff6b6b;
      --nsfw-bg: #e74c3c;
      --nsfw-hover: #c0392b;
      --gold: #e67e22;
      --reais: #10b981;
      --progress-bg: #ecf0f1;
      --tutorial-bg: #3498db;
      --tutorial-hover: #2980b9;
    }
    [data-theme="dark"] {
      --background: #1f2937;
      --surface: #374151;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border: #4b5563;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      --accent: #ff8787;
      --nsfw-bg: #c0392b;
      --nsfw-hover: #a5281a;
      --gold: #e6a24b;
      --reais: #059669;
      --progress-bg: #4b5563;
      --tutorial-bg: #1e90ff;
      --tutorial-hover: #1c86ee;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Ubuntu', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1rem;
      text-align: center;
      width: 100%;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-family: 'Jura', sans-serif;
      font-size: 1.8rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .theme-button {
      padding: 0.5rem 1rem;
      background: var(--tutorial-bg);
      border: none;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .theme-button:hover {
      background: var(--tutorial-hover);
      transform: scale(1.05);
    }
    .status-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      padding: 1rem;
      background: var(--surface);
      box-shadow: var(--shadow);
      gap: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 600;
      width: 100%;
      max-width: 1200px;
      border-radius: 0.375rem;
      margin: 1rem 0;
    }
    .status-bar div {
      padding: 0.75rem;
      background: var(--background);
      border-radius: 0.375rem;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .status-bar div:hover {
      background: var(--secondary);
      color: white;
      transform: translateY(-3px);
    }
    .status-bar span.golds-balance,
    .status-bar span#golds-total {
      color: var(--gold);
      font-size: 1.125rem;
      font-weight: bold;
    }
    .status-bar span.reais-balance {
      color: var(--reais);
      font-size: 1.125rem;
      font-weight: bold;
    }
    .ads-section {
      width: 100%;
      max-width: 1200px;
      padding: 1.5rem 1rem;
      background: var(--surface);
      border-radius: 0.375rem;
      box-shadow: var(--shadow);
      margin: 1.5rem 0;
      animation: fadeIn 0.5s ease forwards;
    }
    .ads-section h2 {
      font-family: 'Jura', sans-serif;
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .carousel-container {
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      display: flex;
      gap: 1rem;
      padding: 0 1rem 1rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
      justify-content: center;
    }
    .carousel-container::-webkit-scrollbar {
      display: none;
    }
    .carousel-container .ad-card {
      flex: 0 0 90%;
      max-width: 400px;
      scroll-snap-align: center;
      position: relative;
      min-height: 400px;
    }
    .ad-card {
      background: var(--background);
      border-radius: 0.375rem;
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid var(--border);
      position: relative;
    }
    .ad-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .ad-card h3 {
      font-family: 'Jura', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .ad-card p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .ad-card .golds-reward {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gold);
      margin: 0.5rem 0;
    }
    .ad-card .steps-list {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .ad-card .steps-list ul {
      list-style-type: disc;
      padding-left: 1.25rem;
    }
    .ad-card .view-button {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      padding: 0.75rem;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .ad-card .view-button:hover {
      background: var(--secondary-hover);
      transform: scale(1.05);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 0.375rem;
      text-align: center;
      animation: slideIn 0.5s ease forwards;
      max-width: 90%;
      width: 500px;
      box-shadow: var(--shadow);
    }
    .modal-content h2 {
      font-family: 'Jura', sans-serif;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }
    .modal-content p {
      color: var(--text-secondary);
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }
    .modal-content input {
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      width: 100%;
      max-width: 200px;
    }
    .modal-content button {
      padding: 0.5rem 1rem;
      background: var(--secondary);
      border: none;
      color: white;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      margin: 0.25rem;
      font-size: 0.875rem;
    }
    .modal-content button.cancel {
      background: var(--accent);
    }
    .modal-content button.cancel:hover {
      background: var(--nsfw-hover);
      transform: scale(1.05);
    }
    .modal-content button:hover {
      background: var(--secondary-hover);
      transform: scale(1.05);
    }
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      color: var(--text-primary);
      padding: 1rem;
      box-shadow: var(--shadow);
      border-top: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      text-align: center;
    }
    [data-theme="dark"] .cookie-banner {
      background: var(--surface);
      border-top: 1px solid var(--border);
    }
    .cookie-banner .content {
      font-size: 0.875rem;
    }
    .cookie-banner .buttons {
      display: flex;
      gap: 0.5rem;
    }
    .cookie-banner button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 0.875rem;
    }
    .cookie-banner button.accept {
      background: var(--secondary);
      color: white;
    }
    .cookie-banner button.accept:hover {
      background: var(--secondary-hover);
    }
    .cookie-banner button.decline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .cookie-banner button.decline:hover {
      background: var(--accent);
      color: white;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @media (max-width: 600px) {
      .header {
        padding: 0.75rem;
        flex-direction: column;
        gap: 0.5rem;
      }
      .header h1 {
        font-size: 1.25rem;
      }
      .theme-button {
        width: 100%;
        max-width: none;
      }
      .status-bar {
        font-size: 0.75rem;
        padding: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      .status-bar div {
        padding: 0.5rem;
      }
      .ads-section {
        padding: 1rem 0.5rem;
      }
      .ads-section h2 {
        font-size: 1.25rem;
      }
      .carousel-container {
        padding: 0 0.5rem 1rem;
      }
      .carousel-container .ad-card {
        flex: 0 0 95%;
        max-width: 350px;
      }
      .modal-content {
        padding: 1rem;
        width: 90%;
      }
      .cookie-banner .buttons {
        flex-direction: column;
        width: 100%;
      }
      .cookie-banner button {
        width: 100%;
      }
    }
    @media (min-width: 601px) and (max-width: 1024px) {
      .header h1 {
        font-size: 1.5rem;
      }
      .ads-section {
        padding: 1rem;
      }
      .ads-section h2 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div id="userStatus" style="background:black;color:lime;padding:6px;position:fixed;top:0;left:0;z-index:9999;font-size:12px">
    Usuário ativo: Carregando...
  </div>
  <header class="header" role="banner">
    <h1>YshippCommerce</h1>
    <div>
      <button class="theme-button" id="theme-toggle">Alternar Tema</button>
    </div>
  </header>
  <main class="flex-grow w-full">
    <div class="status-bar" role="region" aria-label="Resumo de Saldo">
      <div>SALDO EM GOLDS <span class="golds-balance" id="golds-balance"></span></div>
      <div>SALDO EM REAIS <span class="reais-balance" id="reais-balance">R$ 0</span></div>
      <div>GOLDS TOTAIS <span id="golds-total"></span></div>
    </div>
    <section class="ads-section">
      <h2>Gerador de Golds Via Links Curtos</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Acesse links curtos e ganhe 150 Golds por visualização.</p>
      <div class="carousel-container" id="links-carousel"></div>
    </section>
    <section class="ads-section">
      <h2>Gerador de Golds Via Cripto</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Realize tarefas de criptomoedas e ganhe Golds inserindo o código fornecido.</p>
      <div class="carousel-container" id="crypto-carousel"></div>
    </section>
    <section class="ads-section">
      <h2>Gerador de Golds Via Tasks</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">Realize tarefas e ganhe Golds inserindo o código fornecido.</p>
      <div class="carousel-container" id="tasks-carousel"></div>
    </section>
    <div id="welcomeModal" class="modal" role="dialog" aria-labelledby="welcomeMessage">
      <div class="modal-content">
        <h2 id="welcomeMessage">Aviso</h2>
        <p></p>
        <button class="secondary-button" onclick="closeModal('welcomeModal')">OK</button>
      </div>
    </div>
    <div id="cryptoModal" class="modal" role="dialog" aria-labelledby="cryptoMessage">
      <div class="modal-content">
        <h2 id="cryptoMessage">Insira o Código</h2>
        <p>Insira o código fornecido para reivindicar seus Golds.</p>
        <input type="text" id="cryptoCode" placeholder="Digite o código">
        <button onclick="submitCryptoCode()">Confirmar</button>
        <button class="cancel" onclick="closeModal('cryptoModal')">Cancelar</button>
      </div>
    </div>
    <div id="cookieBanner" class="cookie-banner">
      <div class="content">
        <p>Concordo que meu endereço IP seja coletado e enviado ao administrador para identificar atividades.</p>
      </div>
      <div class="buttons">
        <button class="accept" onclick="acceptIPConsent()">Aceitar</button>
        <button class="decline" onclick="declineIPConsent()">Recusar</button>
      </div>
    </div>
  </main>
  <footer class="footer py-4 mt-auto w-full">
    <div class="container text-center">
      <p class="text-sm">© 2025 YshippCommerce. Todos os direitos reservados. Desenvolvido por xAI.</p>
      <div class="flex justify-center space-x-4 mt-2">
        <a href="#" class="text-primary text-sm hover:underline">WhatsApp</a>
        <a href="#" class="text-primary text-sm hover:underline">Facebook</a>
      </div>
    </div>
  </footer>
  <script defer src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyDbxygCeFLDbf6Ge6YZHJqq0VvlSSfbc_I",
        authDomain: "yshippcommerce.firebaseapp.com",
        projectId: "yshippcommerce",
        storageBucket: "yshippcommerce.firebasestorage.app",
        messagingSenderId: "680576769517",
        appId: "1:680576769517:web:ace30d8e451ee70511dbe4"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      window._YSHIPP_db = db;
      window._YSHIPP_auth = auth;

      // Debug: Verificar se Firebase está carregado
      console.assert(typeof firebase !== 'undefined', 'Firebase ainda está indefinido — verifique as tags <script> compat.');
      console.log('Firebase carregado (compat). Versão:', firebase.SDK_VERSION || 'compat');

      // Constants
      const ADMIN_PHONE = "5535984072446";

      // Theme toggle functionality
      function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.dataset.theme = savedTheme;
      }

      function saveTheme(theme) {
        localStorage.setItem('theme', theme);
      }

      // Modal control
      function showModal(modalId, message, autoClose = true) {
        const modal = document.getElementById(modalId);
        if (modalId === 'welcomeModal') {
          modal.querySelector('p').textContent = message;
        }
        modal.style.display = 'flex';
        if (autoClose && !message.includes('redirecionado')) {
          setTimeout(() => {
            modal.style.display = 'none';
          }, 3000);
        }
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }

      // IP consent handling
      function acceptIPConsent() {
        localStorage.setItem('ipConsent', 'true');
        document.getElementById('cookieBanner').style.display = 'none';
      }

      function declineIPConsent() {
        localStorage.setItem('ipConsent', 'false');
        document.getElementById('cookieBanner').style.display = 'none';
        showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.');
      }

      async function getUserIP() {
        try {
          const response = await fetch('https://api.ipify.org?format=json');
          const data = await response.json();
          return data.ip || 'IP não disponível';
        } catch (error) {
          console.error('Erro ao obter IP:', error);
          return 'IP não disponível';
        }
      }

      // Update UI with wallet data
      function updateInterface(walletData) {
        const goldsBalance = walletData.goldsBalance || 0;
        const reaisBalance = walletData.reaisBalance || 0;
        document.getElementById('golds-balance').textContent = goldsBalance.toLocaleString();
        document.getElementById('reais-balance').textContent = `R$ ${reaisBalance.toFixed(2).replace('.', ',')}`;
        document.getElementById('golds-total').textContent = goldsBalance.toLocaleString();
      }

      // Load ads into carousels
      function loadLinksCarousel(links) {
        const carousel = document.getElementById('links-carousel');
        carousel.innerHTML = '';
        links.slice(0, 5).forEach(ad => {
          const golds = ad.golds ?? ad.reward ?? 0;
          const card = document.createElement('div');
          card.classList.add('ad-card');
          card.innerHTML = `
            <h3>${ad.title}</h3>
            <div class="steps-list">
              <strong>Passos:</strong>
              <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
            </div>
            <div class="golds-reward"><strong>Recompensa:</strong> ${golds} Golds</div>
            <button class="view-button" onclick="window.open('${ad.url || '#'}', '_blank'); viewAd('${ad.id}', ${golds})">${ad.buttonText || 'Visualizar Propaganda'}</button>
          `;
          carousel.appendChild(card);
        });
        if (links.length === 0) {
          carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum link disponível.</p>';
        }
      }

      function loadCryptoCarousel(cryptoAds) {
        const carousel = document.getElementById('crypto-carousel');
        carousel.innerHTML = '';
        cryptoAds.slice(0, 1).forEach(ad => {
          const golds = ad.golds ?? ad.reward ?? 0;
          const card = document.createElement('div');
          card.classList.add('ad-card');
          card.innerHTML = `
            <h3>${ad.title}</h3>
            <div class="steps-list">
              <strong>Passos:</strong>
              <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
            </div>
            <div class="golds-reward"><strong>Recompensa:</strong> ${golds} Golds</div>
            <button class="view-button" onclick="showCryptoModal('${ad.id}', ${golds}, '${ad.code}')">${ad.buttonText || 'Insira o Código'}</button>
          `;
          carousel.appendChild(card);
        });
        if (cryptoAds.length === 0) {
          carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma tarefa de cripto disponível.</p>';
        }
      }

      function loadTasksCarousel(tasks) {
        const carousel = document.getElementById('tasks-carousel');
        carousel.innerHTML = '';
        tasks.slice(0, 6).forEach(ad => {
          const reward = ad.golds ?? ad.reward ?? 0;
          const freelancersNeeded = ad.freelancersNeeded ?? ad.slots ?? null;
          const acceptedCount = (ad.acceptedBy && ad.acceptedBy.length) || 0;
          const vagasText = freelancersNeeded ? ` | Vagas: ${Math.max(0, freelancersNeeded - acceptedCount)}` : '';
          const card = document.createElement('div');
          card.classList.add('ad-card');
          card.innerHTML = `
            <h3>${ad.title}</h3>
            <div class="steps-list">
              <strong>Passos:</strong>
              <ul>${(ad.steps || []).map(step => `<li>${step}</li>`).join('')}</ul>
            </div>
            <div class="golds-reward"><strong>Recompensa:</strong> ${reward} Golds${vagasText}</div>
            <button class="view-button" onclick="acceptTask('${ad.id}', ${reward})">${ad.buttonText || 'Aceitar Tarefa'}</button>
          `;
          carousel.appendChild(card);
        });
        if (tasks.length === 0) {
          carousel.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma task disponível.</p>';
        }
      }

      // Handle ad viewing
      function viewAd(adId, golds) {
        const userId = auth.currentUser?.uid;
        if (!userId) {
          showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.');
          return;
        }
        sincronizarGeradorFirebase(userId, adId, golds, `Visualização de link curto ID: ${adId}`, 'receive');
        showModal('welcomeModal', `Você ganhou ${golds} Golds por visualizar o link!`);
      }

      // Handle crypto modal
      function showCryptoModal(adId, golds, code) {
        const userId = auth.currentUser?.uid;
        if (!userId) {
          showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.');
          return;
        }
        if (localStorage.getItem('ipConsent') !== 'true') {
          showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.');
          return;
        }
        window.currentAdId = adId;
        window.currentGolds = golds;
        window.expectedCode = code;
        document.getElementById('cryptoModal').style.display = 'flex';
      }

      async function submitCryptoCode() {
        const userId = auth.currentUser?.uid;
        if (!userId) {
          showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.');
          return;
        }
        if (localStorage.getItem('ipConsent') !== 'true') {
          showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.');
          return;
        }
        const inputCode = document.getElementById('cryptoCode').value.trim();
        if (inputCode === window.expectedCode) {
          const ip = await getUserIP();
          db.collection('wallets').doc(userId).get()
            .then((doc) => {
              if (doc.exists) {
                const walletData = doc.data();
                const message = `Reivindicação de Cripto:\nUsuário: ${walletData.name}\nUserID: ${userId}\nCódigo: ${inputCode}\nGolds: ${window.currentGolds}\nIP: ${ip}`;
                sincronizarGeradorFirebase(userId, window.currentAdId, window.currentGolds, `Reivindicação de cripto ID: ${window.currentAdId}`, 'receive');
                showModal('welcomeModal', `Você será redirecionado para o WhatsApp em 8 segundos para enviar as informações ao atendimento.`, false);
                setTimeout(() => {
                  const whatsappUrl = `https://wa.me/${ADMIN_PHONE}?text=${encodeURIComponent(message)}`;
                  window.open(whatsappUrl, '_blank');
                  closeModal('cryptoModal');
                }, 8000);
              } else {
                showModal('welcomeModal', 'Carteira não encontrada. Tente novamente.');
              }
            })
            .catch((error) => {
              console.error('Erro ao verificar carteira:', error);
              showModal('welcomeModal', 'Erro ao verificar carteira. Tente novamente.');
            });
        } else {
          showModal('welcomeModal', 'Código incorreto. Tente novamente.');
        }
      }

      async function acceptTask(adId, reward) {
        const userId = auth.currentUser?.uid;
        if (!userId) {
          showModal('welcomeModal', 'Usuário não autenticado. Faça login novamente.');
          return;
        }

        const ipConsent = localStorage.getItem('ipConsent');
        if (ipConsent !== 'true') {
          showModal('welcomeModal', 'Você deve aceitar a coleta de IP para continuar.');
          return;
        }

        const adRef = db.collection('offers').doc(adId);
        const walletRef = db.collection('wallets').doc(userId);

        try {
          await db.runTransaction(async (t) => {
            const adDoc = await t.get(adRef);
            if (!adDoc.exists) throw new Error('Tarefa não encontrada.');
            const ad = adDoc.data();

            const required = ad.freelancersNeeded ?? ad.slots ?? null;
            const acceptedBy = Array.isArray(ad.acceptedBy) ? ad.acceptedBy.slice() : [];

            if (acceptedBy.includes(userId)) {
              throw new Error('Você já aceitou esta tarefa.');
            }

            if (required !== null && acceptedBy.length >= required) {
              throw new Error('Vagas para esta tarefa esgotadas.');
            }

            acceptedBy.push(userId);
            const newAdUpdate = { acceptedBy: acceptedBy };
            if (required !== null && acceptedBy.length >= required) {
              newAdUpdate.active = false;
            }
            t.update(adRef, newAdUpdate);

            const walletDoc = await t.get(walletRef);
            const newTransaction = {
              type: 'receive',
              amount: reward,
              currency: 'golds',
              date: new Date().toISOString(),
              description: `Aceitação da tarefa ${adId}`
            };

            if (!walletDoc.exists) {
              t.set(walletRef, {
                userId: userId,
                name: auth.currentUser?.displayName || 'Usuário',
                goldsBalance: reward,
                reaisBalance: 0,
                transactions: [newTransaction]
              });
            } else {
              const w = walletDoc.data();
              const current = Number(w.goldsBalance || 0);
              const txs = Array.isArray(w.transactions) ? w.transactions.slice() : [];
              txs.unshift(newTransaction);
              t.update(walletRef, {
                goldsBalance: current + reward,
                transactions: txs
              });
            }
          });

          const walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
          walletData.goldsBalance = (walletData.goldsBalance || 0) + reward;
          walletData.transactions = walletData.transactions || [];
          walletData.transactions.unshift({
            type: 'receive',
            amount: reward,
            currency: 'golds',
            date: new Date().toISOString(),
            description: `Aceitação da tarefa ${adId}`
          });
          localStorage.setItem('walletData', JSON.stringify(walletData));
          updateInterface({ goldsBalance: walletData.goldsBalance, reaisBalance: walletData.reaisBalance || 0, transactions: walletData.transactions });

          showModal('welcomeModal', `Você ganhou ${reward} Golds por aceitar a tarefa!`);
        } catch (err) {
          console.error('Erro ao aceitar task:', err);
          showModal('welcomeModal', err.message || 'Erro ao aceitar tarefa. Tente novamente.');
        }
      }

      // Synchronize generator data with Firestore
      function sincronizarGeradorFirebase(userId, adId, golds, description, type) {
        db.collection('wallets').doc(userId).get()
          .then((doc) => {
            if (doc.exists) {
              const walletData = doc.data();
              const newTransaction = {
                type: type,
                amount: golds,
                currency: 'golds',
                date: new Date().toLocaleString('pt-BR'),
                description: description
              };
              db.collection('wallets').doc(userId).update({
                goldsBalance: walletData.goldsBalance + golds,
                transactions: [newTransaction, ...(walletData.transactions || [])]
              }).then(() => {
                localStorage.setItem('walletData', JSON.stringify({
                  userId: walletData.userId,
                  name: walletData.name,
                  goldsBalance: walletData.goldsBalance + golds,
                  reaisBalance: walletData.reaisBalance,
                  transactions: [newTransaction, ...(walletData.transactions || [])]
                }));
              }).catch((error) => {
                console.error('Erro ao sincronizar ganhos:', error);
                showModal('welcomeModal', 'Erro ao registrar ganhos. Tente novamente.');
              });
            } else {
              showModal('welcomeModal', 'Carteira não encontrada. Tente novamente.');
            }
          })
          .catch((error) => {
            console.error('Erro ao verificar carteira:', error);
            showModal('welcomeModal', 'Erro ao verificar carteira. Tente novamente.');
          });
      }

      // Load generator data from Firestore
      function carregarGeradorFirebase(userId) {
        console.log('carregarGeradorFirebase chamado para', userId, 'db?', !!db, 'auth?', !!auth);

        // Load wallet data
        db.collection('wallets').doc(userId).onSnapshot((doc) => {
          console.log('Snapshot wallets recebido:', doc.exists ? 'Dados encontrados' : 'Sem dados');
          if (doc.exists) {
            const walletData = doc.data();
            updateInterface(walletData);
            localStorage.setItem('walletData', JSON.stringify({
              userId: walletData.userId,
              name: walletData.name,
              goldsBalance: walletData.goldsBalance,
              reaisBalance: walletData.reaisBalance,
              transactions: walletData.transactions
            }));
          } else {
            const defaultWallet = {
              userId: userId,
              name: auth.currentUser?.displayName || 'Usuário',
              goldsBalance: 0,
              reaisBalance: 0,
              transactions: []
            };
            db.collection('wallets').doc(userId).set(defaultWallet)
              .then(() => {
                console.log('Default wallet created for user:', userId);
                updateInterface(defaultWallet);
                localStorage.setItem('walletData', JSON.stringify(defaultWallet));
              })
              .catch((error) => {
                console.error('Erro ao criar carteira padrão:', error);
                showModal('welcomeModal', 'Erro ao inicializar carteira. Tente novamente.');
              });
          }
        }, (error) => {
          console.error('Erro ao carregar dados da carteira:', error);
          showModal('welcomeModal', 'Erro ao carregar dados da carteira. Tente novamente.');
        });

        // Load offers
        db.collection('offers').where('active', '==', true).onSnapshot((querySnapshot) => {
          console.log('Snapshot offers recebido:', querySnapshot.size, 'itens');
          const links = [];
          const cryptoAds = [];
          const tasks = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const offer = { id: doc.id, ...data };
            if (data.type === 'Link curto') {
              links.push(offer);
            } else if (data.type === 'Cripto') {
              cryptoAds.push(offer);
            } else if (data.type === 'Task') {
              tasks.push(offer);
            }
          });
          loadLinksCarousel(links);
          loadCryptoCarousel(cryptoAds);
          loadTasksCarousel(tasks);
        }, (error) => {
          console.error('Erro ao carregar offers:', error);
          showModal('welcomeModal', 'Erro ao carregar tarefas. Tente novamente.');
        });

        if (localStorage.getItem('ipConsent') !== 'true') {
          document.getElementById('cookieBanner').style.display = 'flex';
        }
      }

      // Theme toggle event listener
      const themeToggleBtn = document.getElementById('theme-toggle');
      themeToggleBtn.addEventListener('click', () => {
        const body = document.body;
        const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
        body.dataset.theme = newTheme;
        saveTheme(newTheme);
      });

      // Load theme on page load
      loadTheme();

      // Authentication
      auth.onAuthStateChanged(user => {
        if (user) {
          console.log('Auth OK. UID:', user.uid);
          document.getElementById('userStatus').textContent = `Usuário ativo: ${user.uid}`;
          carregarGeradorFirebase(user.uid);
        } else {
          window.location.href = 'cadastro.html';
        }
      });
    });
  </script>
  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return '';
        }
      }
      return gk_fileData[filename] || '';
    }
  </script>
  <footer id="userInfoFooter" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #0d1117;
    color: #00ffaa;
    text-align: center;
    font-size: 13px;
    padding: 6px;
    border-top: 1px solid #00ffaa;
    z-index: 9999;
    font-family: 'Ubuntu', sans-serif;">
    Usuário: <span id="footerUserName">Carregando...</span> | ID: <span id="footerUserId">---</span>
  </footer>
</body>
</html>
