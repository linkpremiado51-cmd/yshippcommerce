<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carteira - YshippCommerce</title>

  <!-- Firebase compat (mantendo a versÃ£o 10.12.0 conforme original) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;700&family=Ubuntu:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Estilos mantidos exatamente como fornecidos */
    :root{--background:#f9fafb;--surface:#ffffff;--text-primary:#1f2937;--text-secondary:#6b7280;--primary:#7c3aed;--primary-hover:#6d28d9;--secondary:#10b981;--secondary-hover:#059669;--border:#e5e7eb;--shadow:0 2px 4px rgba(0,0,0,0.1);--accent:#ff6b6b;--gold:#e67e22;--reais:#10b981;--tutorial-bg:#3498db;--tutorial-hover:#2980b9}
    [data-theme="dark"]{--background:#1f2937;--surface:#374151;--text-primary:#f3f4f6;--text-secondary:#9ca3af;--border:#4b5563;--shadow:0 2px 4px rgba(0,0,0,0.3);--accent:#ff8787;--gold:#e6a24b;--reais:#059669;--tutorial-bg:#1e90ff;--tutorial-hover:#1c86ee}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Ubuntu',sans-serif;background:var(--background);color:var(--text-primary);min-height:100vh;display:flex;flex-direction:column;align-items:center}
    .header{background:var(--surface);border-bottom:1px solid var(--border);padding:1rem;width:100%;position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-family:'Jura',sans-serif;font-size:1.3rem;letter-spacing:1px}
    .theme-button{padding:.5rem 1rem;border-radius:.375rem;border:0;background:var(--tutorial-bg);color:#fff;cursor:pointer}
    .balance-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem;width:100%;max-width:1200px;padding:1.2rem}
    .balance-card{border-radius:1rem;padding:1.6rem;color:#fff;position:relative;overflow:hidden;box-shadow:var(--shadow)}
    .balance-card.gold{background:linear-gradient(135deg,#f39c12,#e67e22)}
    .balance-card.reais{background:linear-gradient(135deg,#10b981,#059669)}
    .balance-label{font-size:.85rem;text-transform:uppercase;opacity:.9;margin-bottom:.4rem}
    .balance-amount{font-family:'Jura',sans-serif;font-size:2rem;font-weight:700}
    .wallet-section{width:100%;max-width:1200px;background:var(--surface);padding:1rem;border-radius:.5rem;margin:1rem 0;box-shadow:var(--shadow)}
    .wallet-section h2{font-family:'Jura',sans-serif;margin-bottom:.8rem}
    .action-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-bottom:1rem}
    .action-btn{padding:.9rem;border-radius:.5rem;border:0;font-weight:700;cursor:pointer}
    .action-btn.withdraw{background:var(--primary);color:#fff}
    .action-btn.transfer{background:#3b82f6;color:#fff}
    .action-btn.default{background:var(--secondary);color:#fff}
    .transaction-list{max-height:420px;overflow-y:auto}
    .transaction-item{display:flex;justify-content:space-between;align-items:center;padding:.8rem;border-radius:.5rem;border:1px solid var(--border);margin-bottom:.6rem;background:var(--background)}
    .transaction-type{font-weight:700}
    .transaction-desc{color:var(--text-secondary);font-size:.9rem}
    .transaction-date{color:var(--text-secondary);font-size:.8rem}
    .transaction-amount{font-weight:800}
    footer#userInfoFooter{position:fixed;bottom:0;left:0;width:100%;background:#07121a;color:#00ffb3;text-align:center;padding:.4rem;font-size:13px;z-index:999}
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:9999}
    .modal-content{background:var(--surface);padding:1.1rem;border-radius:.6rem;width:92%;max-width:520px}
    .form-group{margin-bottom:.8rem}
    .form-group label{display:block;margin-bottom:.3rem;font-weight:700}
    .form-group input,.form-group select{width:100%;padding:.6rem;border:1px solid var(--border);border-radius:.4rem}
    #loadingOverlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;z-index:10000}
    @media(max-width:600px){.balance-amount{font-size:1.5rem}}
  </style>
</head>
<body data-theme="light">
  <div id="loadingOverlay">Carregando carteira...</div>

  <header class="header">
    <h1>ðŸ’¼ Carteira - YshippCommerce</h1>
    <div>
      <button id="theme-toggle" class="theme-button">Alternar Tema</button>
    </div>
  </header>

  <main style="width:100%;max-width:1200px;padding:0 1rem 140px;">
    <div class="balance-cards">
      <div class="balance-card gold">
        <div class="balance-label">Saldo em Golds</div>
        <div id="golds-balance" class="balance-amount">0</div>
        <div style="opacity:.85">Moeda virtual do sistema</div>
      </div>
      <div class="balance-card reais">
        <div class="balance-label">Saldo em Reais</div>
        <div id="reais-balance" class="balance-amount">R$ 0,00</div>
        <div style="opacity:.85">Saldo disponÃ­vel para saque</div>
      </div>
    </div>

    <section class="wallet-section">
      <h2>EstatÃ­sticas</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.8rem">
        <div style="padding:.8rem;border-radius:.5rem;border:1px solid var(--border);text-align:center">
          <div style="font-size:.8rem;color:var(--text-secondary)">Total Recebido</div>
          <div id="total-received" style="font-weight:800;font-family:'Jura',sans-serif">0</div>
        </div>
        <div style="padding:.8rem;border-radius:.5rem;border:1px solid var(--border);text-align:center">
          <div style="font-size:.8rem;color:var(--text-secondary)">Total Enviado</div>
          <div id="total-sent" style="font-weight:800;font-family:'Jura',sans-serif">0</div>
        </div>
        <div style="padding:.8rem;border-radius:.5rem;border:1px solid var(--border);text-align:center">
          <div style="font-size:.8rem;color:var(--text-secondary)">TransaÃ§Ãµes</div>
          <div id="total-transactions" style="font-weight:800;font-family:'Jura',sans-serif">0</div>
        </div>
        <div style="padding:.8rem;border-radius:.5rem;border:1px solid var(--border);text-align:center">
          <div style="font-size:.8rem;color:var(--text-secondary)">Ãšltimo Saque</div>
          <div id="last-withdrawal" style="font-weight:800;font-family:'Jura',sans-serif">-</div>
        </div>
      </div>
    </section>

    <section class="wallet-section">
      <h2>AÃ§Ãµes RÃ¡pidas</h2>
      <div class="action-buttons" style="margin-top:.8rem">
        <button class="action-btn default action-btn" onclick="openDepositModal()">ðŸ“¥ Depositar</button>
        <button class="action-btn withdraw" onclick="openWithdrawModal()">ðŸ“¤ Sacar</button>
        <button class="action-btn transfer" onclick="openTransferModal()">ðŸ’¸ Transferir</button>
        <button class="action-btn default" onclick="openConvertModal()">ðŸ”„ Converter</button>
      </div>
    </section>

    <section class="wallet-section">
      <h2>HistÃ³rico de TransaÃ§Ãµes</h2>
      <div id="transaction-list" class="transaction-list" style="margin-top:.6rem">
        <div style="text-align:center;color:var(--text-secondary);padding:1.5rem">Carregando transaÃ§Ãµes...</div>
      </div>
    </section>
  </main>

  <!-- Modais -->
  <div id="depositModal" class="modal"><div class="modal-content">
    <h3>ðŸ’° Depositar</h3>
    <div class="form-group"><label>MÃ©todo</label><select id="deposit-method"><option value="pix">PIX</option><option value="boleto">Boleto</option><option value="card">CartÃ£o</option></select></div>
    <div class="form-group"><label>Valor (R$)</label><input id="deposit-amount" type="number" min="1" step="0.01"></div>
    <div style="display:flex;gap:.6rem"><button class="action-btn default" onclick="processDeposit()">Confirmar</button><button class="action-btn" onclick="closeModal('depositModal')" style="background:#fff;color:#000;border:1px solid var(--border)">Cancelar</button></div>
  </div></div>

  <div id="withdrawModal" class="modal"><div class="modal-content">
    <h3>ðŸ“¤ Saque</h3>
    <div class="form-group"><label>Moeda</label><select id="withdraw-currency"><option value="reais">Reais</option><option value="golds">Golds</option></select></div>
    <div class="form-group"><label>Valor</label><input id="withdraw-amount" type="number" min="1" step="0.01"></div>
    <div class="form-group"><label>Chave PIX (destino)</label><input id="pix-key" type="text"></div>
    <div style="display:flex;gap:.6rem"><button class="action-btn withdraw" onclick="processWithdrawal()">Solicitar Saque</button><button class="action-btn" onclick="closeModal('withdrawModal')" style="background:#fff;color:#000;border:1px solid var(--border)">Cancelar</button></div>
  </div></div>

  <div id="transferModal" class="modal"><div class="modal-content">
    <h3>ðŸ’¸ Transferir</h3>
    <div class="form-group"><label>ID do destinatÃ¡rio</label><input id="recipient-id" type="text"></div>
    <div class="form-group"><label>Moeda</label><select id="transfer-currency"><option value="golds">Golds</option><option value="reais">Reais</option></select></div>
    <div class="form-group"><label>Valor</label><input id="transfer-amount" type="number" min="1" step="0.01"></div>
    <div style="display:flex;gap:.6rem"><button class="action-btn transfer" onclick="processTransfer()">Enviar</button><button class="action-btn" onclick="closeModal('transferModal')" style="background:#fff;color:#000;border:1px solid var(--border)">Cancelar</button></div>
  </div></div>

  <div id="convertModal" class="modal"><div class="modal-content">
    <h3>ðŸ”„ Converter</h3>
    <div class="form-group"><label>Converter</label><select id="convert-from"><option value="golds">Golds</option><option value="reais">Reais</option></select></div>
    <div class="form-group"><label>Valor</label><input id="convert-amount" type="number" min="1" step="1"></div>
    <div class="form-group"><label>Para</label><select id="convert-to"><option value="reais">Reais</option><option value="golds">Golds</option></select></div>
    <div style="display:flex;gap:.6rem"><button class="action-btn default" onclick="processConversion()">Confirmar ConversÃ£o</button><button class="action-btn" onclick="closeModal('convertModal')" style="background:#fff;color:#000;border:1px solid var(--border)">Cancelar</button></div>
  </div></div>

  <!-- Notification -->
  <div id="notificationModal" class="modal"><div class="modal-content">
    <h3 id="notification-title">NotificaÃ§Ã£o</h3>
    <p id="notification-message" style="color:var(--text-secondary)"></p>
    <div style="display:flex;gap:.6rem"><button class="action-btn default" onclick="closeModal('notificationModal')">OK</button></div>
  </div></div>

  <footer id="userInfoFooter">UsuÃ¡rio: <span id="footerUserName">Carregando...</span> | ID: <span id="footerUserId">---</span></footer>

  <script>
    // -------------------------
    // ConfiguraÃ§Ã£o Firebase
    // -------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDbxygCeFLDbf6Ge6YZHJqq0VvlSSfbc_I",
      authDomain: "yshippcommerce.firebaseapp.com",
      projectId: "yshippcommerce",
      storageBucket: "yshippcommerce.firebasestorage.app",
      messagingSenderId: "680576769517",
      appId: "1:680576769517:web:ace30d8e451ee70511dbe4"
    };

    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase carregado.');
      } else {
        console.log('Firebase jÃ¡ inicializado.');
      }
    } catch (e) {
      console.error('Erro inicializando Firebase:', e);
      showNotification('Erro', 'Erro ao inicializar Firebase. Verifique as credenciais.');
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let walletData = null;
    const GOLD_TO_REAL_RATE = 1000; // 1000 Golds = R$1

    // -------------------------
    // UI helpers
    // -------------------------
    function openModal(id){document.getElementById(id).style.display='flex'}
    function closeModal(id){document.getElementById(id).style.display='none'}
    function showNotification(title,message){document.getElementById('notification-title').textContent=title;document.getElementById('notification-message').textContent=message;openModal('notificationModal')}

    // Theme
    function loadTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      document.body.dataset.theme = saved;
    }
    document.getElementById('theme-toggle').addEventListener('click',()=>{
      const newTheme = document.body.dataset.theme==='light' ? 'dark' : 'light';
      document.body.dataset.theme = newTheme; localStorage.setItem('theme', newTheme);
    });
    loadTheme();

    // -------------------------
    // AutenticaÃ§Ã£o e carregamento de carteira
    // -------------------------
    async function ensureAnonymousSignIn(){
      try {
        console.warn('Nenhum usuÃ¡rio logado. Tentando login anÃ´nimo...');
        const res = await auth.signInAnonymously();
        console.log('Login anÃ´nimo realizado. UID:', res.user.uid);
      } catch (error) {
        console.error('Erro ao autenticar anonimamente:', error);
        showNotification('Erro de autenticaÃ§Ã£o', `NÃ£o foi possÃ­vel logar anonimamente: ${error.code} - ${error.message}`);
      }
    }

    // Observador de estado de autenticaÃ§Ã£o
    auth.onAuthStateChanged(async user => {
      console.log('auth.onAuthStateChanged ->', user ? 'UsuÃ¡rio detectado' : 'Nenhum usuÃ¡rio');
      if (!user) {
        await ensureAnonymousSignIn();
        return;
      }
      currentUser = user;
      document.getElementById('footerUserId').textContent = user.uid;
      document.getElementById('footerUserName').textContent = user.displayName || (user.isAnonymous ? 'AnÃ´nimo' : (user.email || 'UsuÃ¡rio'));
      console.log('UsuÃ¡rio ativo:', user.uid);

      // [GROCK EDIT]: SincronizaÃ§Ã£o de carteira existente no re-login
      try {
        const walletRef = db.collection('wallets').doc(user.uid);
        const walletSnap = await walletRef.get();

        if (!walletSnap.exists) {
          // Cria carteira nova apenas se nÃ£o houver nenhuma
          await walletRef.set({
            userId: user.uid,
            name: user.displayName || (user.isAnonymous ? 'AnÃ´nimo' : 'UsuÃ¡rio'),
            goldsBalance: 0,
            reaisBalance: 0,
            transactions: [],
            createdAt: new Date().toISOString()
          });
          console.log('[GROCK EDIT] Carteira nova criada (usuÃ¡rio sem histÃ³rico)');
        } else {
          // Sincroniza dados da carteira existente
          walletData = walletSnap.data();
          console.log('[GROCK EDIT] Carteira existente sincronizada:', walletData);
          atualizarInterfaceCarteira(walletData);
        }
      } catch (error) {
        console.error('[GROCK EDIT] Erro ao sincronizar carteira:', error);
        showNotification('Erro', `Erro ao sincronizar carteira: ${error.message}`);
      }

      await loadWalletData(user.uid);
      document.getElementById('loadingOverlay').style.display = 'none';
    });

    // Carregar/ Inicializar carteira no Firestore
    async function loadWalletData(uid){
      try {
        const ref = db.collection('wallets').doc(uid);
        const snap = await ref.get();
        if (!snap.exists) {
          // Carteira jÃ¡ criada no onAuthStateChanged, mas mantemos para consistÃªncia
          const initial = {
            userId: uid,
            name: auth.currentUser?.displayName || (auth.currentUser?.isAnonymous ? 'AnÃ´nimo' : 'UsuÃ¡rio'),
            goldsBalance: 0,
            reaisBalance: 0,
            transactions: [],
            createdAt: new Date().toISOString()
          };
          await ref.set(initial);
          walletData = initial;
          renderWallet();
          console.log('Carteira criada para', uid);
          return;
        }
        walletData = snap.data();
        renderWallet();
        console.log('Carteira carregada para', uid, walletData);
      } catch (err) {
        console.error('Erro ao carregar carteira:', err);
        showNotification('Erro', 'NÃ£o foi possÃ­vel carregar os dados da carteira. Veja console.');
      }
    }

    // Atualiza a UI com dados da carteira local (walletData)
    function renderWallet(){
      if (!walletData) return;
      document.getElementById('golds-balance').textContent = (walletData.goldsBalance || 0).toLocaleString();
      document.getElementById('reais-balance').textContent = `R$ ${(walletData.reaisBalance || 0).toFixed(2).replace('.',',')}`;

      const txs = walletData.transactions || [];
      document.getElementById('total-transactions').textContent = txs.length;
      let totalReceived = 0, totalSent = 0, lastWithdrawal = '-';
      txs.forEach(tx=>{
        if (tx.type === 'receive') totalReceived += (tx.amount || 0);
        if (tx.type === 'send' || tx.type === 'withdraw') totalSent += (tx.amount || 0);
        if (tx.type === 'withdraw') lastWithdrawal = new Date(tx.date).toLocaleDateString('pt-BR');
      });
      document.getElementById('total-received').textContent = totalReceived.toLocaleString();
      document.getElementById('total-sent').textContent = totalSent.toLocaleString();
      document.getElementById('last-withdrawal').textContent = lastWithdrawal;

      renderTransactions();
    }

    // [GROCK EDIT]: Atualiza interface com dados de carteira existentes
    function atualizarInterfaceCarteira(walletData) {
      document.getElementById('golds-balance').textContent = (walletData.goldsBalance || 0).toLocaleString();
      document.getElementById('reais-balance').textContent = `R$ ${(walletData.reaisBalance || 0).toFixed(2).replace('.', ',')}`;

      const txs = walletData.transactions || [];
      document.getElementById('total-transactions').textContent = txs.length;
      let totalReceived = 0, totalSent = 0, lastWithdrawal = '-';
      txs.forEach(tx => {
        if (tx.type === 'receive') totalReceived += (tx.amount || 0);
        if (tx.type === 'send' || tx.type === 'withdraw') totalSent += (tx.amount || 0);
        if (tx.type === 'withdraw') lastWithdrawal = new Date(tx.date).toLocaleDateString('pt-BR');
      });
      document.getElementById('total-received').textContent = totalReceived.toLocaleString();
      document.getElementById('total-sent').textContent = totalSent.toLocaleString();
      document.getElementById('last-withdrawal').textContent = lastWithdrawal;

      renderTransactions();
    }

    function renderTransactions(){
      const listEl = document.getElementById('transaction-list');
      const txs = (walletData && walletData.transactions) ? walletData.transactions.slice().reverse() : [];
      if (!txs.length) {
        listEl.innerHTML = `<div style="text-align:center;padding:1.2rem;color:var(--text-secondary)"><svg viewBox="0 0 24 24" width="48" height="48" style="opacity:.6"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg><div>Nenhuma transaÃ§Ã£o ainda</div></div>`;
        return;
      }
      listEl.innerHTML = txs.map(tx => {
        const typeMap = { receive: 'Recebido', send: 'Enviado', withdraw: 'Saque', deposit: 'DepÃ³sito', conversion: 'ConversÃ£o' };
        const amountLabel = tx.currency === 'golds' ? `${tx.amount} Golds` : `R$ ${Number(tx.amount).toFixed(2).replace('.',',')}`;
        const sign = (tx.type === 'receive' ? '+' : '-') ;
        const amountClass = tx.type === 'receive' ? 'transaction-amount receive' : 'transaction-amount send';
        const when = new Date(tx.date).toLocaleString('pt-BR');
        const desc = tx.description || '';
        return `
          <div class="transaction-item">
            <div style="flex:1;min-width:0">
              <div class="transaction-type">${typeMap[tx.type] || tx.type}</div>
              <div class="transaction-desc">${desc}</div>
              <div class="transaction-date">${when}</div>
            </div>
            <div style="margin-left:1rem;text-align:right">
              <div class="${amountClass}">${sign} ${amountLabel}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // -------------------------
    // Helpers para atualizar Firestore
    // -------------------------
    async function saveWallet(updated){
      if (!currentUser || !currentUser.uid) throw new Error('UsuÃ¡rio nÃ£o autenticado');
      try {
        await db.collection('wallets').doc(currentUser.uid).set(updated, { merge: true });
        walletData = {...walletData, ...updated};
        renderWallet();
      } catch(err){
        console.error('Erro salvando wallet:', err);
        throw err;
      }
    }

    async function pushTransaction(tx){
      if (!walletData) walletData = {};
      const arr = Array.isArray(walletData.transactions) ? walletData.transactions : [];
      arr.push(tx);
      await saveWallet({ transactions: arr });
    }

    // -------------------------
    // AÃ§Ãµes (Deposit / Withdraw / Transfer / Convert)
    // -------------------------
    async function processDeposit(){
      const amount = Number(document.getElementById('deposit-amount').value);
      if (!amount || amount <= 0) { showNotification('Erro', 'Informe um valor vÃ¡lido para depÃ³sito.'); return; }
      try {
        const newReais = (walletData.reaisBalance || 0) + amount;
        await saveWallet({ reaisBalance: newReais });
        await pushTransaction({ type:'deposit', amount, currency:'reais', description:'DepÃ³sito via mÃ©todo selecionado', date: new Date().toISOString() });
        closeModal('depositModal');
        showNotification('Sucesso', `DepÃ³sito de R$ ${amount.toFixed(2)} registrado.`);
      } catch(err){
        console.error('Erro depositar:', err);
        showNotification('Erro', 'Erro ao processar depÃ³sito. Veja console.');
      }
    }

    async function processWithdrawal(){
      const currency = document.getElementById('withdraw-currency').value;
      const amount = Number(document.getElementById('withdraw-amount').value);
      if (!amount || amount <= 0) { showNotification('Erro', 'Valor invÃ¡lido para saque.'); return; }
      if (currency === 'reais') {
        if ((walletData.reaisBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Reais.'); return; }
        const newReais = (walletData.reaisBalance || 0) - amount;
        try {
          await saveWallet({ reaisBalance: newReais });
          await pushTransaction({ type:'withdraw', amount, currency:'reais', description:'Saque para conta (PIX)', date:new Date().toISOString() });
          closeModal('withdrawModal');
          showNotification('SolicitaÃ§Ã£o enviada', `Saque de R$ ${amount.toFixed(2)} solicitado.`);
        } catch(err){
          console.error('Erro saque:', err);
          showNotification('Erro', 'NÃ£o foi possÃ­vel solicitar saque.');
        }
      } else {
        if ((walletData.goldsBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Golds.'); return; }
        const goldsToRemove = amount;
        const reaisEquivalent = amount / GOLD_TO_REAL_RATE;
        try {
          await saveWallet({ goldsBalance: (walletData.goldsBalance || 0) - goldsToRemove, reaisBalance: (walletData.reaisBalance||0) + 0 });
          await pushTransaction({ type:'withdraw', amount:amount, currency:'golds', description:`Saque de ${amount} Golds (equiv. R$ ${reaisEquivalent.toFixed(2)})`, date:new Date().toISOString() });
          closeModal('withdrawModal');
          showNotification('SolicitaÃ§Ã£o enviada', `Saque de ${amount} Golds solicitado.`);
        } catch(err){
          console.error('Erro saque golds:', err);
          showNotification('Erro', 'NÃ£o foi possÃ­vel solicitar saque em Golds.');
        }
      }
    }

    async function processTransfer(){
      const recipientId = document.getElementById('recipient-id').value.trim();
      const currency = document.getElementById('transfer-currency').value;
      const amount = Number(document.getElementById('transfer-amount').value);
      if (!recipientId) { showNotification('Erro', 'Informe o ID do destinatÃ¡rio.'); return; }
      if (!amount || amount <= 0) { showNotification('Erro', 'Valor invÃ¡lido.'); return; }
      if (recipientId === (currentUser && currentUser.uid)) { showNotification('Erro', 'NÃ£o Ã© possÃ­vel transferir para si mesmo.'); return; }

      try {
        const recipientRef = db.collection('wallets').doc(recipientId);
        const recipientSnap = await recipientRef.get();
        if (!recipientSnap.exists) {
          showNotification('Erro', 'DestinatÃ¡rio nÃ£o encontrado.');
          return;
        }

        if (currency === 'reais') {
          if ((walletData.reaisBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Reais.'); return; }
          const batch = db.batch();
          const senderRef = db.collection('wallets').doc(currentUser.uid);
          batch.update(senderRef, {
            reaisBalance: (walletData.reaisBalance || 0) - amount,
            transactions: firebase.firestore.FieldValue.arrayUnion({ type:'send', amount, currency:'reais', description:`TransferÃªncia para ${recipientId}`, date:new Date().toISOString(), to:recipientId })
          });
          batch.update(recipientRef, {
            reaisBalance: (recipientSnap.data().reaisBalance || 0) + amount,
            transactions: firebase.firestore.FieldValue.arrayUnion({ type:'receive', amount, currency:'reais', description:`Recebido de ${currentUser.uid}`, date:new Date().toISOString(), from:currentUser.uid })
          });
          await batch.commit();
          await loadWalletData(currentUser.uid);
          closeModal('transferModal');
          showNotification('Sucesso', `TransferÃªncia de R$ ${amount.toFixed(2)} enviada.`);
        } else {
          if ((walletData.goldsBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Golds.'); return; }
          const batch = db.batch();
          const senderRef = db.collection('wallets').doc(currentUser.uid);
          batch.update(senderRef, {
            goldsBalance: (walletData.goldsBalance || 0) - amount,
            transactions: firebase.firestore.FieldValue.arrayUnion({ type:'send', amount, currency:'golds', description:`TransferÃªncia para ${recipientId}`, date:new Date().toISOString(), to:recipientId })
          });
          batch.update(recipientRef, {
            goldsBalance: (recipientSnap.data().goldsBalance || 0) + amount,
            transactions: firebase.firestore.FieldValue.arrayUnion({ type:'receive', amount, currency:'golds', description:`Recebido de ${currentUser.uid}`, date:new Date().toISOString(), from:currentUser.uid })
          });
          await batch.commit();
          await loadWalletData(currentUser.uid);
          closeModal('transferModal');
          showNotification('Sucesso', `TransferÃªncia de ${amount} Golds enviada.`);
        }
      } catch(err){
        console.error('Erro transferir:', err);
        showNotification('Erro', 'Falha ao processar transferÃªncia. Veja console.');
      }
    }

    async function processConversion(){
      const from = document.getElementById('convert-from').value;
      const to = document.getElementById('convert-to').value;
      const amount = Number(document.getElementById('convert-amount').value);
      if (!amount || amount <= 0) { showNotification('Erro', 'Valor invÃ¡lido.'); return; }
      if (from === to) { showNotification('Erro', 'Escolha moedas diferentes.'); return; }

      try {
        if (from === 'golds' && to === 'reais') {
          if ((walletData.goldsBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Golds.'); return; }
          const reais = amount / GOLD_TO_REAL_RATE;
          const newGolds = (walletData.goldsBalance || 0) - amount;
          const newReais = (walletData.reaisBalance || 0) + reais;
          await saveWallet({ goldsBalance: newGolds, reaisBalance: newReais });
          await pushTransaction({ type:'conversion', amount, currency:'golds', description:`ConversÃ£o ${amount} Golds â†’ R$ ${reais.toFixed(2)}`, date: new Date().toISOString() });
          closeModal('convertModal');
          showNotification('ConversÃ£o', `Convertido ${amount} Golds para R$ ${reais.toFixed(2)}`);
        } else if (from === 'reais' && to === 'golds') {
          if ((walletData.reaisBalance || 0) < amount) { showNotification('Erro', 'Saldo insuficiente em Reais.'); return; }
          const golds = Math.floor(amount * GOLD_TO_REAL_RATE);
          const newReais = (walletData.reaisBalance || 0) - amount;
          const newGolds = (walletData.goldsBalance || 0) + golds;
          await saveWallet({ reaisBalance: newReais, goldsBalance: newGolds });
          await pushTransaction({ type:'conversion', amount: golds, currency:'golds', description:`ConversÃ£o R$ ${amount.toFixed(2)} â†’ ${golds} Golds`, date: new Date().toISOString() });
          closeModal('convertModal');
          showNotification('ConversÃ£o', `Convertido R$ ${amount.toFixed(2)} para ${golds} Golds`);
        }
      } catch(err){
        console.error('Erro conversÃ£o:', err);
        showNotification('Erro', 'Falha ao converter. Veja console.');
      }
    }

    // -------------------------
    // InicializaÃ§Ã£o
    // -------------------------
    (function init(){
      document.getElementById('loadingOverlay').style.display = 'flex';
      console.log('Aguardando autenticaÃ§Ã£o...');
    })();

    // Expor funÃ§Ãµes para botÃµes inline
    window.openDepositModal = openDepositModal;
    window.openWithdrawModal = openWithdrawModal;
    window.openTransferModal = openTransferModal;
    window.openConvertModal = openConvertModal;
    window.processDeposit = processDeposit;
    window.processWithdrawal = processWithdrawal;
    window.processTransfer = processTransfer;
    window.processConversion = processConversion;
    window.closeModal = closeModal;
    window.showNotification = showNotification;

  </script>
</body>
</html>
